<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #ffffff; --text-color: #1a1a1a; --accent-color: #000000; --placeholder-bg: #f0f0f0; }
        @media (prefers-color-scheme: dark) { :root { --bg-color: #000000; --text-color: #e5e5e5; --accent-color: #ffffff; --placeholder-bg: #1c1c1e; } }
        body.js-loading { opacity: 0; visibility: hidden; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Noto Serif TC', serif; margin: 0; height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; transition: opacity 0.8s ease; }
        * { cursor: none !important; }
        @media (hover: none) or (max-width: 768px) { * { cursor: auto !important; } }
        #custom-cursor { position: fixed; top: 0; left: 0; width: 12px; height: 12px; background-color: var(--accent-color); transform: rotate(45deg); pointer-events: none; z-index: 99999; transition: transform 0.1s, width 0.2s, height 0.2s, background-color 0.2s, border 0.2s; }
        #custom-cursor.hollow { background: transparent; border: 1.5px solid var(--accent-color); transform: rotate(45deg) scale(1.2); }
        #custom-cursor.clicking { transform: rotate(45deg) scale(0.8); background: var(--accent-color); }
        .back-arrow { position: fixed; top: 30px; left: 30px; opacity: 0.5; z-index: 100; transition: 0.3s; border: none; background: none; padding: 0; }
        .back-arrow:hover { opacity: 1; }
        .back-arrow svg { width: 24px; height: 24px; fill: var(--text-color); }
        .reader-viewport { flex: 1; width: 100%; max-width: 800px; margin: 80px auto; position: relative; touch-action: pan-y; }
        .page-slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 0 40px; opacity: 0; pointer-events: none; transform: translateX(30px); transition: opacity 0.4s ease, transform 0.4s ease; display: flex; flex-direction: column; justify-content: center; gap: 25px; box-sizing: border-box; }
        .page-slide.active { opacity: 1; pointer-events: auto; transform: translateX(0); }
        .page-slide.is-swiping { transition: none; }
        p { font-size: clamp(1.1rem, 2.2vmin, 1.35rem); line-height: 1.9; text-align: justify; transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); transform-origin: left center; }
        p:hover { transform: scale(1.02); }
        p:active { transform: scale(0.98); }
        figure { margin: 0; padding: 0; }
        figure img { max-width: 100%; height: auto; display: block; border-radius: 4px; }
        figcaption { font-size: 0.9rem; font-family: sans-serif; text-align: center; opacity: 0.7; margin-top: 10px; }
        .loading-placeholder { width: 100%; height: 250px; background-color: var(--placeholder-bg); border-radius: 4px; animation: pulse 1.5s infinite ease-in-out; margin: auto; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        .title-slide { text-align: center; }
        .title-slide h1 { font-size: 2.2rem; font-weight: 500; margin-bottom: 20px; }
        .title-slide .meta { font-size: 0.9rem; opacity: 0.6; font-family: sans-serif; }
        .pagination { position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: center; align-items: center; gap: 40px; font-family: sans-serif; font-size: 0.9rem; user-select: none; }
        .nav-btn { opacity: 0.3; padding: 10px; transition: 0.3s; border: none; background: none; color: inherit; font-family: inherit; font-size: inherit; }
        .nav-btn:hover, .nav-btn:focus { opacity: 1; outline: none; }
        .nav-btn:disabled { opacity: 0.1; }
        .page-indicator { opacity: 0.5; font-size: 0.8rem; letter-spacing: 2px; }
        @media (max-width: 768px) { #custom-cursor { display: none; } .reader-viewport { margin: 60px auto 100px; } .page-slide { padding: 0 25px; gap: 20px; } .pagination { bottom: 20px; } }
    </style>
</head>
<body class="js-loading">
    <div id="custom-cursor"></div>
    <button class="back-arrow interactable" onclick="goBack()" aria-label="返回文章列表">
        <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </button>
    <main class="reader-viewport" id="viewport" aria-live="polite" aria-atomic="true">
        <div class="loading-placeholder"></div>
    </main>
    <nav class="pagination" role="navigation" aria-label="文章分頁">
        <button class="nav-btn interactable" id="prev-btn" aria-controls="viewport">PREV</button>
        <div class="page-indicator" id="page-num" aria-live="polite">1 / 1</div>
        <button class="nav-btn interactable" id="next-btn" aria-controls="viewport">NEXT</button>
    </nav>

    <script>
        // --- 核心修改點 1: 此檔案不再包含 articleContent ---

        const viewport = document.getElementById('viewport');
        const pageNum = document.getElementById('page-num');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const cursor = document.getElementById('custom-cursor');

        let currentPage = 0, totalPages = 0, pages = [];
        let touchStartX = 0, touchMoveX = 0, isSwiping = false;
        
        // --- 核心修改點 2: 新增一個函數來獲取文章數據 ---
        async function fetchArticleContent(id) {
            if (!id) {
                viewport.innerHTML = `<p style="text-align: center;">錯誤：未在連結中指定文章 ID。</p>`;
                throw new Error("Article ID is missing.");
            }
            try {
                // 根據 ID 構建 JSON 檔案的路徑
                const response = await fetch(`./article/${id}.json`);
                if (!response.ok) {
                    throw new Error(`找不到文章檔案 (HTTP ${response.status})`);
                }
                return await response.json();
            } catch (error) {
                console.error("無法載入文章:", error);
                viewport.innerHTML = `<p style="text-align: center;">載入文章失敗。請檢查文章 ID 是否正確。</p>`;
                throw error;
            }
        }

        async function layoutArticle(articleContent) {
            document.title = articleContent.title;
            viewport.innerHTML = `<div class="loading-placeholder" style="margin: auto;"></div>`;
            pages = []; currentPage = 0;
            const viewportHeight = viewport.clientHeight;
            if (viewportHeight <= 0) return;

            const titlePage = createPageDiv(0, true);
            titlePage.innerHTML = `<h1>${articleContent.title}</h1><div class="meta">${articleContent.date}</div>`;
            pages.push(titlePage);

            let contentPageIndex = 1, currentPageDiv = createPageDiv(1);
            pages.push(currentPageDiv);
            
            const pageStyle = getComputedStyle(currentPageDiv);
            const paragraphGap = parseFloat(pageStyle.gap) || 25;
            const tempDiv = document.createElement('div');
            tempDiv.style.cssText = `visibility: hidden; position: absolute; width: ${viewport.clientWidth - (parseFloat(pageStyle.paddingLeft) + parseFloat(pageStyle.paddingRight))}px;`;
            document.body.appendChild(tempDiv);
            
            let currentHeight = 0;
            try {
                for (const item of articleContent.paragraphs) {
                    let element;
                    if (typeof item === 'string') {
                        element = document.createElement('p');
                        element.className = 'interactable-text';
                        element.innerText = item;
                        element.onclick = () => copyText(element);
                    } else if (item.type === 'image') {
                        element = document.createElement('figure');
                        const img = document.createElement('img');
                        const placeholder = document.createElement('div');
                        placeholder.className = 'loading-placeholder';
                        element.appendChild(placeholder);
                        try {
                            await new Promise((resolve, reject) => {
                                img.onload = resolve; img.onerror = reject;
                                img.src = item.src; img.alt = item.alt || '';
                            });
                            element.replaceChild(img, placeholder);
                        } catch {
                            element.innerHTML = '<p style="text-align:center;">圖片載入失敗</p>';
                        }
                        if (item.caption) {
                            const figcaption = document.createElement('figcaption');
                            figcaption.innerText = item.caption;
                            element.appendChild(figcaption);
                        }
                    }
                    if (!element) continue;
                    tempDiv.innerHTML = ''; tempDiv.appendChild(element.cloneNode(true));
                    const elementHeight = tempDiv.clientHeight;
                    if (currentHeight > 0 && currentHeight + elementHeight + paragraphGap > viewportHeight) {
                        contentPageIndex++;
                        currentPageDiv = createPageDiv(contentPageIndex);
                        pages.push(currentPageDiv);
                        currentHeight = 0;
                    }
                    currentPageDiv.appendChild(element);
                    currentHeight += (elementHeight + paragraphGap);
                }
            } finally {
                document.body.removeChild(tempDiv);
            }
            viewport.innerHTML = '';
            pages.forEach(page => viewport.appendChild(page));
            totalPages = pages.length;
            updatePage();
            bindCursorEvents();
        }
        
        function goBack() {
            document.body.style.opacity = '0';
            // 因為 reader.html 在根目錄，所以直接跳轉到 articles.html
            setTimeout(() => { window.location.href = './articles.html'; }, 500);
        }

        async function initialize() {
            try {
                const params = new URLSearchParams(window.location.search);
                const articleId = params.get('id'); // 從 ?id=... 獲取
                const articleContent = await fetchArticleContent(articleId);
                await document.fonts.ready;
                await layoutArticle(articleContent);
                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => layoutArticle(articleContent), 250);
                });
                initNavigation();
                initSwipeNavigation();
                initCursor();
            } catch (error) {
                console.error("初始化失敗:", error);
            } finally {
                document.body.classList.remove('js-loading');
            }
        }
        
        // --- 其他輔助函數 (無需修改) ---
        function createPageDiv(index, isTitle = false) { const div = document.createElement('div'); div.className = 'page-slide'; if (isTitle) div.classList.add('title-slide'); div.dataset.index = index; return div; }
        function changePage(dir) { const newPage = currentPage + dir; if (newPage >= 0 && newPage < totalPages) { currentPage = newPage; updatePage(); } }
        function updatePage() { pages.forEach((page, index) => { page.style.transform = ''; page.classList.remove('is-swiping'); page.classList.toggle('active', index === currentPage); }); pageNum.innerText = `${currentPage + 1} / ${totalPages}`; prevBtn.disabled = (currentPage === 0); nextBtn.disabled = (currentPage === totalPages - 1); }
        async function copyText(el) { try { await navigator.clipboard.writeText(el.innerText); } catch (err) { console.error('Failed to copy text: ', err); } }
        function initNavigation() { prevBtn.addEventListener('click', () => changePage(-1)); nextBtn.addEventListener('click', () => changePage(1)); document.addEventListener('keydown', (e) => { if (e.key === 'ArrowLeft') { e.preventDefault(); prevBtn.click(); } else if (e.key === 'ArrowRight') { e.preventDefault(); nextBtn.click(); } }); }
        function initSwipeNavigation() { if (!window.matchMedia("(hover: none) or (max-width: 768px)").matches) return; viewport.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; touchMoveX = touchStartX; isSwiping = true; pages[currentPage]?.classList.add('is-swiping'); }, { passive: true }); viewport.addEventListener('touchmove', (e) => { if (!isSwiping) return; touchMoveX = e.touches[0].clientX; const deltaX = touchMoveX - touchStartX; const activePage = pages[currentPage]; if (!activePage) return; let constrainedDeltaX = deltaX; if ((currentPage === 0 && deltaX > 0) || (currentPage === totalPages - 1 && deltaX < 0)) { constrainedDeltaX *= 0.4; } activePage.style.transform = `translateX(${constrainedDeltaX}px)`; }, { passive: true }); viewport.addEventListener('touchend', () => { if (!isSwiping) return; isSwiping = false; const deltaX = touchMoveX - touchStartX; const swipeThreshold = 50; if (deltaX < -swipeThreshold) { changePage(1); } else if (deltaX > swipeThreshold) { changePage(-1); } else { updatePage(); } pages[currentPage]?.classList.remove('is-swiping'); }, { passive: true }); }
        function initCursor() { if (window.matchMedia("(hover: none) or (max-width: 768px)").matches) return; document.addEventListener('mousemove', e => { cursor.style.left = `${e.clientX}px`; cursor.style.top = `${e.clientY}px`; }); document.addEventListener('mousedown', () => cursor.classList.add('clicking')); document.addEventListener('mouseup', () => cursor.classList.remove('clicking')); bindCursorEvents(); }
        function bindCursorEvents() { if (window.matchMedia("(hover: none) or (max-width: 768px)").matches) return; document.querySelectorAll('.interactable, .interactable-text').forEach(el => { el.addEventListener('mouseenter', () => cursor.classList.add('hollow')); el.addEventListener('mouseleave', () => cursor.classList.remove('hollow')); }); }

        window.addEventListener('load', initialize);
    </script>
</body>
</html>
