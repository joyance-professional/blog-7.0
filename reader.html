<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Article Reader</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-color: #ffffff; 
            --text-color: #1a1a1a; 
            --accent-color: #000000; 
            --placeholder-bg: #f0f0f0;
            --toc-bg: #fafafa;
            --toc-width: 280px;
            --lightbox-bg: rgba(255, 255, 255, 0.95);
        }
        @media (prefers-color-scheme: dark) { 
            :root { 
                --bg-color: #000000; 
                --text-color: #e5e5e5; 
                --accent-color: #ffffff; 
                --placeholder-bg: #1c1c1e; 
                --toc-bg: #111111;
                --lightbox-bg: rgba(0, 0, 0, 0.95);
            } 
        }

        /* 基礎設定 */
        body.js-loading { opacity: 0; visibility: hidden; }
        body { 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            font-family: 'Noto Serif TC', serif; 
            margin: 0; height: 100vh; width: 100vw; 
            overflow: hidden; 
            transition: opacity 0.8s ease;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* 游標 */
        @media (min-width: 769px) { * { cursor: none !important; } }
        #custom-cursor { position: fixed; top: 0; left: 0; width: 12px; height: 12px; background-color: var(--accent-color); transform: rotate(45deg); pointer-events: none; z-index: 99999; transition: transform 0.1s, background-color 0.2s; mix-blend-mode: difference; }
        #custom-cursor.hollow { background: transparent; border: 1.5px solid var(--accent-color); transform: rotate(45deg) scale(1.5); }
        #custom-cursor.clicking { transform: rotate(45deg) scale(0.8); background: var(--accent-color); }

        /* 核心佈局容器 */
        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* 閱讀視口 (左側/主體) */
        .reader-section {
            flex: 1;
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: margin-right 0.4s ease;
        }

        .reader-viewport { 
            flex: 1; 
            width: 100%; 
            max-width: 800px; 
            margin: 0 auto; 
            position: relative; 
            touch-action: pan-y; 
            margin-top: 80px;
            margin-bottom: 80px;
        }

        /* 頁面 Slide */
        .page-slide { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            padding: 0 40px; 
            opacity: 0; pointer-events: none; 
            transform: translateX(30px); 
            transition: opacity 0.4s ease, transform 0.4s ease; 
            display: flex; flex-direction: column; justify-content: center; 
            gap: 20px; 
        }
        .page-slide.active { opacity: 1; pointer-events: auto; transform: translateX(0); }
        .page-slide.is-swiping { transition: none; }

        /* 文本樣式 */
        p { 
            font-size: clamp(1.1rem, 2.2vmin, 1.35rem); 
            line-height: 1.8; 
            text-align: justify; 
            margin: 0;
            overflow-wrap: break-word;
            word-break: break-word; 
            hyphens: auto;
        }
        h1, h2, h3 { margin: 0; font-weight: 700; line-height: 1.4; }
        h1 { font-size: 2.2rem; text-align: center; }
        h2 { font-size: 1.6rem; margin-top: 10px; border-left: 4px solid var(--accent-color); padding-left: 15px; }
        h3 { font-size: 1.3rem; margin-top: 5px; opacity: 0.9; }

        /* 圖片樣式 */
        figure { margin: 0; padding: 0; width: 100%; display: flex; flex-direction: column; align-items: center; }
        figure img { 
            max-width: 100%; 
            max-height: 60vh; /* 限制圖片高度，避免佔滿全屏無法閱讀 */
            height: auto; 
            display: block; 
            border-radius: 4px; 
            cursor: zoom-in !important;
            transition: transform 0.3s;
        }
        @media (min-width: 769px) { figure img:hover { transform: scale(1.01); } }
        figcaption { font-size: 0.85rem; font-family: sans-serif; text-align: center; opacity: 0.6; margin-top: 8px; }

        /* 載入與錯誤狀態 */
        .loading-placeholder { 
            width: 100%; height: 250px; 
            background-color: var(--placeholder-bg); 
            border-radius: 4px; 
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            animation: pulse 1.5s infinite ease-in-out; 
        }
        .retry-btn {
            margin-top: 10px; border: 1px solid var(--text-color); background: none; color: var(--text-color);
            padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; cursor: pointer !important; pointer-events: auto;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* 目錄側邊欄 (Desktop) */
        .toc-sidebar {
            width: 0; /* 預設關閉 */
            height: 100vh;
            background-color: var(--toc-bg);
            overflow: hidden;
            border-left: 1px solid rgba(128,128,128, 0.1);
            transition: width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            flex-shrink: 0;
        }
        .app-container.toc-open .toc-sidebar { width: var(--toc-width); }
        
        .toc-content {
            width: var(--toc-width);
            height: 100%;
            padding: 40px 30px;
            overflow-y: auto;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .app-container.toc-open .toc-content { opacity: 1; transition-delay: 0.2s; }
        
        .toc-title { font-size: 1.2rem; margin-bottom: 20px; border-bottom: 1px solid var(--accent-color); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center;}
        .toc-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color); padding: 0; line-height: 1; }
        
        .toc-list { list-style: none; padding: 0; margin: 0; }
        .toc-item { margin-bottom: 12px; cursor: pointer !important; opacity: 0.6; transition: 0.2s; font-size: 0.95rem; line-height: 1.5; }
        .toc-item:hover { opacity: 1; transform: translateX(5px); }
        .toc-item.level-2 { padding-left: 20px; font-size: 0.9rem; }
        .toc-item.active { opacity: 1; font-weight: 500; color: var(--accent-color); }

        /* 導航欄與按鈕 */
        .back-arrow { position: fixed; top: 30px; left: 30px; opacity: 0.5; z-index: 100; transition: 0.3s; border: none; background: none; padding: 0; }
        .back-arrow:hover { opacity: 1; }
        .back-arrow svg { width: 24px; height: 24px; fill: var(--text-color); }
        
        .toc-toggle-btn {
            position: fixed; top: 30px; right: 30px; z-index: 100;
            opacity: 0.5; transition: 0.3s; border: none; background: none; padding: 0;
            display: none; /* 僅在有目錄時顯示 */
        }
        .toc-toggle-btn:hover { opacity: 1; }
        .toc-toggle-btn svg { width: 24px; height: 24px; fill: var(--text-color); }

        .pagination { position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: center; align-items: center; gap: 40px; font-family: sans-serif; font-size: 0.9rem; user-select: none; z-index: 50; }
        .nav-btn { opacity: 0.3; padding: 10px; transition: 0.3s; border: none; background: none; color: inherit; font-family: inherit; font-size: inherit; }
        .nav-btn:hover { opacity: 1; }
        .nav-btn:disabled { opacity: 0.05; cursor: default !important; }
        .page-indicator { opacity: 0.6; font-size: 0.8rem; letter-spacing: 2px; cursor: pointer !important; padding: 10px; transition: 0.3s; border-radius: 4px; }
        .page-indicator:hover { background: rgba(128,128,128,0.1); opacity: 1; }
        
        /* 手機版目錄 (Bottom Sheet) */
        .mobile-toc-overlay {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
            z-index: 200;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
            display: flex; flex-direction: column; justify-content: flex-end;
        }
        .mobile-toc-overlay.active { opacity: 1; pointer-events: auto; }
        
        .mobile-toc-panel {
            background: var(--bg-color);
            width: 100%;
            max-height: 40vh; /* 覆蓋下 1/3 ~ 40% */
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 25px;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
        }
        .mobile-toc-overlay.active .mobile-toc-panel { transform: translateY(0); }
        .mobile-toc-handle { width: 40px; height: 4px; background: var(--text-color); opacity: 0.2; border-radius: 2px; margin: 0 auto 20px; }

        /* Lightbox (圖片放大) */
        .lightbox {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--lightbox-bg);
            z-index: 300;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }
        .lightbox.active { opacity: 1; pointer-events: auto; }
        .lightbox img { max-width: 90%; max-height: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: zoom-out !important; }
        .lightbox.active img { transform: scale(1); }

        /* 退出提示 (Pull to Exit) */
        .exit-hint {
            position: fixed; left: 0; width: 100%; text-align: center;
            font-size: 0.9rem; letter-spacing: 2px;
            opacity: 0; transition: 0.3s; pointer-events: none;
            z-index: 90;
        }
        .exit-hint.top { top: 30%; transform: translateY(-20px); }
        .exit-hint.bottom { bottom: 30%; transform: translateY(20px); }
        .exit-hint.visible { opacity: 0.6; transform: translateY(0); }
        .exit-hint.active { opacity: 1; text-shadow: 0 0 10px var(--accent-color); font-weight: bold; }

        /* RWD 調整 */
        @media (max-width: 768px) { 
            #custom-cursor { display: none; } 
            .reader-viewport { margin: 60px auto 100px; max-width: 100%; } 
            .page-slide { padding: 0 25px; gap: 15px; } 
            .pagination { bottom: 20px; } 
            .app-container { flex-direction: column; }
            .toc-sidebar { display: none; } /* 手機隱藏 Desktop 側邊欄 */
            .back-arrow { top: 20px; left: 20px; }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.4rem; }
            p { font-size: 1.15rem; line-height: 1.7; }
        }
    </style>
</head>
<body class="js-loading">
    <div id="custom-cursor"></div>

    <!-- 圖片放大燈箱 -->
    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
        <img id="lightbox-img" src="" alt="Zoomed Image">
    </div>

    <!-- 退出提示 -->
    <div class="exit-hint top" id="exit-hint-top">釋放返回列表</div>
    <div class="exit-hint bottom" id="exit-hint-bottom">釋放返回列表</div>

    <!-- 手機版目錄 Bottom Sheet -->
    <div class="mobile-toc-overlay" id="mobile-toc" onclick="toggleMobileToc(false)">
        <div class="mobile-toc-panel" onclick="event.stopPropagation()">
            <div class="mobile-toc-handle" onclick="toggleMobileToc(false)"></div>
            <div class="toc-title">文章目錄</div>
            <ul class="toc-list" id="mobile-toc-list"></ul>
        </div>
    </div>

    <div class="app-container" id="app-container">
        <!-- 閱讀區域 -->
        <main class="reader-section">
            <button class="back-arrow interactable" onclick="goBack()" aria-label="返回文章列表">
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <button class="toc-toggle-btn interactable" id="toc-btn" onclick="toggleDesktopToc()" aria-label="目錄">
                <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </button>

            <div class="reader-viewport" id="viewport" aria-live="polite">
                <div class="loading-placeholder"></div>
            </div>

            <nav class="pagination" role="navigation">
                <button class="nav-btn interactable" id="prev-btn">PREV</button>
                <div class="page-indicator interactable" id="page-num" onclick="toggleMobileToc(true)">1 / 1</div>
                <button class="nav-btn interactable" id="next-btn">NEXT</button>
            </nav>
        </main>

        <!-- 電腦版目錄側邊欄 -->
        <aside class="toc-sidebar">
            <div class="toc-content">
                <div class="toc-title">
                    目錄
                    <button class="toc-close-btn interactable" onclick="toggleDesktopToc()">×</button>
                </div>
                <ul class="toc-list" id="desktop-toc-list">
                    <!-- JS 生成 -->
                </ul>
            </div>
        </aside>
    </div>

    <script>
        // --- 變數與初始化 ---
        const viewport = document.getElementById('viewport');
        const pageNum = document.getElementById('page-num');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const tocBtn = document.getElementById('toc-btn');
        const appContainer = document.getElementById('app-container');
        const mobileToc = document.getElementById('mobile-toc');
        const cursor = document.getElementById('custom-cursor');
        
        // 狀態變數
        let currentPage = 0, totalPages = 0, pages = [];
        let tocData = []; // 結構: { text, level, pageIndex }
        let touchStartX = 0, touchStartY = 0, touchMoveY = 0;
        let isSwiping = false, isPullingVertical = false;
        let pullStage = 0; // 0: none, 1: hint, 2: active
        
        // 模擬數據獲取 (實際應替換為 fetch)
        async function fetchArticleContent(id) {
            // 為了演示，直接使用題目提供的數據結構
            // 實際項目請保留這裡的 fetch 邏輯
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve({
                        "title": "幾何美學與影像",
                        "date": "2023.11.02",
                        "paragraphs": [
                            "這是第一段內容。在數字的荒原裡，我們試圖用線條和角度構建一座燈塔。現在，這個世界也加入了影像的維度。",
                            { "type": "header", "level": 1, "text": "第一章：光影結構" },
                            {
                                "type": "image",
                                "src": "https://images.unsplash.com/photo-1593111985590-3b9c612b7f5e?q=80&w=2592&auto=format&fit=crop",
                                "alt": "一個有著幾何光影的建築內部",
                                "caption": "光線穿過幾何結構，構成空間的詩意。"
                            },
                            "設計不應該喧賓奪主，而應該退居幕後。白色背景，黑色文字，沒有多餘的裝飾。每一個像素的間距都是為了呼吸而留。",
                            { "type": "header", "level": 2, "text": "1.1 細節的意義" },
                            "這是第四段測試長文本。當網絡不好的時候，Moment 頁面的圖片會顯示加載動畫，而在文章頁面，所有的文字都是即時渲染的。",
                            "我們會逝去，但影像與文字會留下來。翻頁閱讀讓思緒有了停頓的間隙，不再是無止盡的滑動。",
                            { "type": "header", "level": 1, "text": "結語" },
                            "最後一段。保持熱愛，奔赴山海。純粹的記錄，時候比圖像更有力量。"
                        ]
                    });
                }, 800); // 模擬網絡延遲
            });
        }

        // --- 核心排版引擎 ---
        async function layoutArticle(articleContent) {
            document.title = articleContent.title;
            // 初始化清空
            viewport.innerHTML = '';
            pages = []; 
            currentPage = 0;
            tocData = [];

            const viewportHeight = viewport.clientHeight;
            const viewportWidth = viewport.clientWidth;
            if (viewportHeight <= 0) return; // 防止未渲染時錯誤

            // 1. 標題頁
            const titlePage = createPageDiv(0, true);
            titlePage.innerHTML = `<h1>${articleContent.title}</h1><div class="meta" style="text-align:center; opacity:0.6; margin-top:10px;">${articleContent.date}</div>`;
            pages.push(titlePage);

            // 2. 準備內容排版
            let contentPageIndex = 1;
            let currentPageDiv = createPageDiv(1);
            pages.push(currentPageDiv);
            
            // 隱藏的計算容器
            const tempDiv = document.createElement('div');
            const pageStyle = getComputedStyle(currentPageDiv);
            const paddingV = (parseFloat(pageStyle.paddingTop) || 0) + (parseFloat(pageStyle.paddingBottom) || 0);
            const effectiveHeight = viewportHeight - paddingV;
            const paragraphGap = parseFloat(pageStyle.gap) || 20;

            tempDiv.style.cssText = `visibility: hidden; position: absolute; width: ${viewportWidth - (parseFloat(pageStyle.paddingLeft) + parseFloat(pageStyle.paddingRight))}px; left: 0; top: 0; z-index: -1;`;
            document.body.appendChild(tempDiv);
            
            let currentContentHeight = 0;

            try {
                // 逐個處理段落
                for (const item of articleContent.paragraphs) {
                    let element;
                    
                    // A. 純文字
                    if (typeof item === 'string') {
                        element = document.createElement('p');
                        element.className = 'interactable-text';
                        element.innerText = item;
                        element.onclick = () => copyText(element);
                    } 
                    // B. 標題 (目錄節點)
                    else if (item.type === 'header') {
                        element = document.createElement('h' + (item.level === 1 ? '2' : '3')); // 文章內標題降級顯示
                        element.innerText = item.text;
                        element.className = 'interactable-text';
                        
                        // 記錄目錄數據：注意此時還沒確定是否換頁，需先預判
                        // 但為了簡化，我們先排版，排完後再確認它在第幾頁
                    }
                    // C. 圖片
                    else if (item.type === 'image') {
                        element = document.createElement('figure');
                        const placeholder = document.createElement('div');
                        placeholder.className = 'loading-placeholder';
                        element.appendChild(placeholder);
                        
                        // 圖片處理邏輯
                        const img = new Image();
                        img.className = 'interactable';
                        img.onclick = () => openLightbox(item.src);
                        img.alt = item.alt || '';
                        
                        // 處理 Caption
                        let capEl;
                        if (item.caption) {
                            capEl = document.createElement('figcaption');
                            capEl.innerText = item.caption;
                        }

                        // 異步加載圖片以獲取高度
                        // 優化：設定超時，若加載太慢則先用佔位符高度排版
                        try {
                            await Promise.race([
                                new Promise((resolve, reject) => {
                                    img.onload = () => resolve();
                                    img.onerror = () => reject();
                                    img.src = item.src;
                                }),
                                new Promise((_, reject) => setTimeout(() => reject('timeout'), 5000))
                            ]);
                            element.replaceChild(img, placeholder);
                        } catch (err) {
                            // 加載失敗或超時
                            placeholder.style.animation = 'none';
                            placeholder.innerHTML = `<span style="font-size:0.8rem; opacity:0.5; margin-bottom:5px;">圖片載入失敗</span>`;
                            const retryBtn = document.createElement('button');
                            retryBtn.innerText = "重試載入";
                            retryBtn.className = "retry-btn interactable";
                            retryBtn.onclick = (e) => {
                                e.stopPropagation();
                                img.src = item.src + `?retry=${Date.now()}`; // 防止緩存
                                // 這裡簡單處理，實際可能需要重新觸發佈局
                                placeholder.innerHTML = '';
                                placeholder.style.animation = 'pulse 1.5s infinite';
                            };
                            placeholder.appendChild(retryBtn);
                        }
                        
                        if (capEl) element.appendChild(capEl);
                    }

                    if (!element) continue;

                    // 計算高度邏輯
                    tempDiv.innerHTML = ''; 
                    tempDiv.appendChild(element.cloneNode(true));
                    const elementHeight = tempDiv.clientHeight;

                    // 判斷是否換頁
                    if (currentContentHeight > 0 && currentContentHeight + elementHeight + paragraphGap > effectiveHeight) {
                        contentPageIndex++;
                        currentPageDiv = createPageDiv(contentPageIndex);
                        pages.push(currentPageDiv);
                        currentContentHeight = 0;
                    }

                    // 如果是標題，記錄現在所在的頁碼
                    if (item.type === 'header') {
                        tocData.push({
                            text: item.text,
                            level: item.level,
                            pageIndex: contentPageIndex
                        });
                    }

                    currentPageDiv.appendChild(element);
                    currentContentHeight += (elementHeight + paragraphGap);
                }
            } finally {
                document.body.removeChild(tempDiv);
            }

            // 3. 渲染所有頁面
            pages.forEach(page => viewport.appendChild(page));
            totalPages = pages.length;
            
            // 4. 更新 UI
            updatePage();
            buildTOC(); // 建立目錄
            bindCursorEvents();
            
            // 電腦版若有目錄默認展開
            if (window.innerWidth > 768 && tocData.length > 0) {
                appContainer.classList.add('toc-open');
                tocBtn.style.display = 'block';
            } else if (tocData.length > 0) {
                tocBtn.style.display = 'block'; // 手機版顯示按鈕 (其實是頁碼觸發，保留按鈕也行)
            }
        }

        // --- 目錄功能 ---
        function buildTOC() {
            const listContent = tocData.map((item, idx) => `
                <li class="toc-item level-${item.level}" onclick="jumpToPage(${item.pageIndex})">
                    ${item.text}
                </li>
            `).join('');
            
            document.getElementById('desktop-toc-list').innerHTML = listContent;
            document.getElementById('mobile-toc-list').innerHTML = listContent;
        }

        function toggleDesktopToc() {
            if (tocData.length === 0) return;
            appContainer.classList.toggle('toc-open');
            // 重新計算佈局可能有必要，但因為 flex 佈局通常會自動處理寬度，這裡僅觸發動畫
        }

        function toggleMobileToc(show) {
            if (tocData.length === 0 && show) return;
            if (show) mobileToc.classList.add('active');
            else mobileToc.classList.remove('active');
        }

        function jumpToPage(index) {
            currentPage = index;
            updatePage();
            toggleMobileToc(false);
            // 手機版跳轉後隱藏目錄，電腦版可保持
        }

        // --- 圖片燈箱 ---
        function openLightbox(src) {
            const lb = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = src;
            lb.classList.add('active');
        }
        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
        }

        // --- 頁面導航與交互 ---
        function createPageDiv(index, isTitle = false) { 
            const div = document.createElement('div'); 
            div.className = 'page-slide'; 
            if (isTitle) div.classList.add('title-slide'); 
            div.dataset.index = index; 
            return div; 
        }

        function changePage(dir) { 
            const newPage = currentPage + dir; 
            if (newPage >= 0 && newPage < totalPages) { 
                currentPage = newPage; 
                updatePage(); 
            } else {
                // 邊界回彈效果
            }
        }

        function updatePage() { 
            pages.forEach((page, index) => { 
                page.style.transform = ''; 
                page.classList.remove('is-swiping'); 
                page.classList.toggle('active', index === currentPage); 
            }); 
            pageNum.innerText = `${currentPage + 1} / ${totalPages}`; 
            prevBtn.disabled = (currentPage === 0); 
            nextBtn.disabled = (currentPage === totalPages - 1);
            
            // 更新目錄高亮
            document.querySelectorAll('.toc-item').forEach(el => el.classList.remove('active'));
            // 簡單查找最接近的章節
            let activeHeader = null;
            for(let i=0; i<tocData.length; i++) {
                if(tocData[i].pageIndex <= currentPage) activeHeader = i;
            }
            if (activeHeader !== null) {
                const itemsD = document.querySelectorAll('#desktop-toc-list .toc-item');
                const itemsM = document.querySelectorAll('#mobile-toc-list .toc-item');
                if(itemsD[activeHeader]) itemsD[activeHeader].classList.add('active');
                if(itemsM[activeHeader]) itemsM[activeHeader].classList.add('active');
            }
        }

        // --- 觸控事件 (增強版：包含退出邏輯) ---
        function initSwipeNavigation() { 
            if (!window.matchMedia("(hover: none) or (max-width: 768px)").matches) return; 

            viewport.addEventListener('touchstart', (e) => { 
                touchStartX = e.touches[0].clientX; 
                touchStartY = e.touches[0].clientY;
                isSwiping = true; 
                isPullingVertical = false;
                pullStage = 0;
                pages[currentPage]?.classList.add('is-swiping'); 
            }, { passive: true }); 

            viewport.addEventListener('touchmove', (e) => { 
                if (!isSwiping) return; 
                const touchX = e.touches[0].clientX;
                const touchY = e.touches[0].clientY;
                const deltaX = touchX - touchStartX; 
                const deltaY = touchY - touchStartY;

                // 判斷是水平翻頁還是垂直操作
                if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > 10) {
                    // 垂直邏輯
                    isPullingVertical = true;
                    
                    // 上滑打開目錄
                    if (deltaY < -50 && !mobileToc.classList.contains('active')) {
                        toggleMobileToc(true);
                        isSwiping = false; // 停止處理翻頁
                        return;
                    }
                }

                if (isPullingVertical) return;

                // 水平翻頁邏輯 & 退出邏輯
                // 第一頁向前拉 -> 退出提示
                if (currentPage === 0 && deltaX > 0) {
                    handlePullExit(deltaX, 'top');
                } 
                // 最後一頁向後拉 -> 退出提示
                else if (currentPage === totalPages - 1 && deltaX < 0) {
                    handlePullExit(Math.abs(deltaX), 'bottom');
                }
                else {
                    const activePage = pages[currentPage]; 
                    if (!activePage) return; 
                    activePage.style.transform = `translateX(${deltaX}px)`; 
                }
            }, { passive: true }); 

            viewport.addEventListener('touchend', (e) => { 
                if (!isSwiping) return; 
                isSwiping = false; 
                const touchX = e.changedTouches[0].clientX;
                const deltaX = touchX - touchStartX; 
                const swipeThreshold = 50; 

                // 處理退出
                if (pullStage === 2) {
                    goBack();
                    return;
                }
                resetPullExit();

                if (isPullingVertical) return;

                if (deltaX < -swipeThreshold) { changePage(1); } 
                else if (deltaX > swipeThreshold) { changePage(-1); } 
                else { updatePage(); } 
                pages[currentPage]?.classList.remove('is-swiping'); 
            }, { passive: true }); 
        }

        function handlePullExit(delta, type) {
            const hint = document.getElementById(`exit-hint-${type}`);
            const otherHint = document.getElementById(type === 'top' ? 'exit-hint-bottom' : 'exit-hint-top');
            otherHint.classList.remove('visible', 'active'); // 確保另一個隱藏

            const threshold1 = 80;
            const threshold2 = 180;

            if (delta > threshold2) {
                hint.innerText = "正在返回...";
                hint.classList.add('active');
                pullStage = 2;
            } else if (delta > threshold1) {
                hint.innerText = "釋放返回列表";
                hint.classList.add('visible');
                hint.classList.remove('active');
                pullStage = 1;
            } else {
                hint.classList.remove('visible', 'active');
                pullStage = 0;
            }
        }

        function resetPullExit() {
            document.querySelectorAll('.exit-hint').forEach(el => el.classList.remove('visible', 'active'));
            pullStage = 0;
        }

        function goBack() {
            document.body.style.opacity = '0';
            setTimeout(() => { window.location.href = './articles.html'; }, 500);
        }

        async function copyText(el) { try { await navigator.clipboard.writeText(el.innerText); } catch (err) { console.error(err); } }

        // --- 初始化流程 ---
        async function initialize() {
            try {
                const params = new URLSearchParams(window.location.search);
                const articleId = params.get('id') || 'demo'; // 預設 demo 供測試
                
                const articleContent = await fetchArticleContent(articleId);
                await document.fonts.ready;
                
                await layoutArticle(articleContent);

                // Resize 處理 (防抖)
                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        // 只在寬度改變或高度劇烈改變時重新佈局（防止手機瀏覽器 bar 伸縮觸發）
                        layoutArticle(articleContent);
                    }, 300);
                });

                initNavigation();
                initSwipeNavigation();
                initCursor();

            } catch (error) {
                console.error("初始化失敗:", error);
                viewport.innerHTML = `<p style="text-align:center; padding-top:50px;">載入文章發生錯誤<br><span style="font-size:0.8rem; opacity:0.6">${error.message}</span></p>`;
            } finally {
                document.body.classList.remove('js-loading');
            }
        }
        
        // 基礎導航綁定
        function initNavigation() { 
            prevBtn.addEventListener('click', () => changePage(-1)); 
            nextBtn.addEventListener('click', () => changePage(1)); 
            document.addEventListener('keydown', (e) => { 
                if (e.key === 'ArrowLeft') { prevBtn.click(); } 
                else if (e.key === 'ArrowRight') { nextBtn.click(); } 
                else if (e.key === 'Escape') { closeLightbox(); toggleMobileToc(false); }
            }); 
        }

        // 游標邏輯
        function initCursor() { 
            if (window.matchMedia("(hover: none) or (max-width: 768px)").matches) return; 
            document.addEventListener('mousemove', e => { 
                cursor.style.left = `${e.clientX}px`; 
                cursor.style.top = `${e.clientY}px`; 
            }); 
            document.addEventListener('mousedown', () => cursor.classList.add('clicking')); 
            document.addEventListener('mouseup', () => cursor.classList.remove('clicking')); 
            bindCursorEvents(); 
        }

        function bindCursorEvents() { 
            if (window.matchMedia("(hover: none) or (max-width: 768px)").matches) return; 
            document.querySelectorAll('.interactable, .interactable-text').forEach(el => { 
                el.addEventListener('mouseenter', () => cursor.classList.add('hollow')); 
                el.addEventListener('mouseleave', () => cursor.classList.remove('hollow')); 
            }); 
        }

        window.addEventListener('load', initialize);
    </script>
</body>
</html>
