<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Article</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-color: #ffffff; 
            --text-color: #2c2c2c; /* 稍微柔和的黑 */
            --accent-color: #000000; 
            --placeholder-bg: #f5f5f5; 
            
            /* 核心佈局參數 */
            --page-margin-top: 80px;
            --page-margin-bottom: 80px;
            
            /* 靈動動畫曲線 - Apple/iOS 風格的彈性 */
            --ease-fluid: cubic-bezier(0.2, 0.8, 0.2, 1);
            --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @media (prefers-color-scheme: dark) { 
            :root { --bg-color: #0a0a0a; --text-color: #e0e0e0; --accent-color: #ffffff; --placeholder-bg: #1c1c1e; } 
        }

        body.js-loading { opacity: 0; }
        body { 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            font-family: 'Noto Serif TC', serif; 
            margin: 0; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden; 
            transition: opacity 0.8s ease; 
            /* 禁止選取，增強 App 感 */
            user-select: none;
            -webkit-user-select: none;
        }
        
        * { cursor: none !important; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        @media (hover: none) or (max-width: 768px) { * { cursor: auto !important; } }

        /* 佈局容器 */
        #app-container { display: flex; width: 100%; height: 100%; position: relative; }
        .main-content { flex: 1; position: relative; height: 100%; display: flex; flex-direction: column; overflow: hidden; }

        /* --- 靈動鼠標 (Cursor) --- */
        .cursor-dot, .cursor-circle {
            position: fixed; top: 0; left: 0; pointer-events: none; z-index: 99999; border-radius: 50%;
            transform: translate(-50%, -50%); 
        }
        .cursor-dot { width: 6px; height: 6px; background-color: var(--accent-color); transition: opacity 0.3s; }
        .cursor-circle { 
            width: 30px; height: 30px; border: 1px solid var(--accent-color); 
            opacity: 0.4;
            /* 使用更平滑的拖尾動畫 */
            transition: transform 0.15s ease-out, width 0.3s var(--ease-fluid), height 0.3s var(--ease-fluid), opacity 0.3s;
        }
        body.is-hovering .cursor-circle { width: 50px; height: 50px; opacity: 0.8; background: rgba(128,128,128,0.05); border-color: transparent; }
        body.is-clicking .cursor-dot { transform: translate(-50%, -50%) scale(0.5); }
        body.is-clicking .cursor-circle { transform: translate(-50%, -50%) scale(0.8); }

        /* --- 頂部導航與漢堡菜單 --- */
        .top-controls { position: fixed; top: 30px; left: 30px; z-index: 100; pointer-events: none; }
        .menu-trigger { position: fixed; top: 30px; right: 30px; z-index: 2100; pointer-events: auto; mix-blend-mode: difference; color: #fff;}
        
        .icon-btn { opacity: 0.4; transition: opacity 0.3s, transform 0.3s var(--ease-fluid); border: none; background: none; padding: 10px; display: flex; align-items: center; justify-content: center; pointer-events: auto; }
        .icon-btn:hover { opacity: 1; transform: scale(1.1); }
        .icon-btn svg { width: 20px; height: 20px; fill: var(--text-color); }

        .hamburger { width: 30px; height: 14px; position: relative; cursor: none; display: flex; flex-direction: column; justify-content: space-between; }
        .hamburger span { display: block; width: 100%; height: 1.5px; background-color: var(--text-color); transition: 0.4s var(--ease-fluid); }
        /* 漢堡動畫 */
        .hamburger.active span:nth-child(1) { transform: translateY(6px) rotate(45deg); background-color: var(--accent-color); }
        .hamburger.active span:nth-child(2) { opacity: 0; transform: scale(0); }
        .hamburger.active span:nth-child(3) { transform: translateY(-6px) rotate(-45deg); background-color: var(--accent-color); }

        /* 全屏菜單 Overlay */
        .menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; 
            transition: opacity 0.5s var(--ease-fluid), visibility 0.5s;
        }
        .menu-overlay.open { opacity: 1; visibility: visible; }
        .menu-item { 
            font-size: 1.8rem; margin: 15px 0; font-weight: 300; 
            opacity: 0; transform: translateY(30px); 
            transition: 0.6s var(--ease-fluid); cursor: none; 
        }
        .menu-overlay.open .menu-item { opacity: 1; transform: translateY(0); }
        .menu-overlay.open .menu-item:nth-child(1) { transition-delay: 0.1s; }
        .menu-overlay.open .menu-item:nth-child(2) { transition-delay: 0.2s; }
        .menu-item:hover { color: var(--accent-color); letter-spacing: 2px; transform: scale(1.05); }

        /* --- 閱讀視口 (排版核心) --- */
        .reader-viewport { 
            flex: 1; 
            width: 100%; 
            max-width: 760px; /* 稍微縮窄增加精緻感 */
            height: calc(100vh - var(--page-margin-top) - var(--page-margin-bottom));
            margin: var(--page-margin-top) auto var(--page-margin-bottom); 
            position: relative; 
            touch-action: pan-y; 
            perspective: 1000px; /* 為3D變換做準備 */
        }
        
        .page-slide { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 0 40px; 
            opacity: 0; pointer-events: none; 
            /* 預設狀態：向右偏移且稍微縮小，製造進場深度感 */
            transform: translateX(40px) scale(0.98); 
            transform-origin: center center;
            transition: opacity 0.6s var(--ease-fluid), transform 0.6s var(--ease-fluid); 
            display: flex; flex-direction: column; justify-content: flex-start;
            gap: 28px; 
            overflow: hidden; 
        }
        
        /* 頁面激活狀態 */
        .page-slide.active { 
            opacity: 1; pointer-events: auto; 
            transform: translateX(0) scale(1); 
        }
        
        /* 前一頁的狀態 (向左退場) */
        .page-slide.prev-page {
            transform: translateX(-40px) scale(0.98);
            opacity: 0;
        }

        /* 標題頁特殊排版 */
        .page-slide.title-slide { justify-content: center; text-align: center; }
        .page-slide.title-slide h1 { font-size: 2.2rem; margin-bottom: 15px; }

        /* --- 內容元素進場動畫 (Staggered Animation) --- */
        /* 預設隱藏，通過 .active 觸發動畫 */
        .page-slide > * { opacity: 0; transform: translateY(15px); transition: opacity 0.6s ease-out, transform 0.6s var(--ease-fluid); }
        
        .page-slide.active > *:nth-child(1) { opacity: 1; transform: translateY(0); transition-delay: 0.1s; }
        .page-slide.active > *:nth-child(2) { opacity: 1; transform: translateY(0); transition-delay: 0.15s; }
        .page-slide.active > *:nth-child(3) { opacity: 1; transform: translateY(0); transition-delay: 0.2s; }
        .page-slide.active > *:nth-child(4) { opacity: 1; transform: translateY(0); transition-delay: 0.25s; }
        .page-slide.active > *:nth-child(5) { opacity: 1; transform: translateY(0); transition-delay: 0.3s; }

        /* 拖曳時禁用動畫，保證跟手 */
        .reader-viewport.no-anim .page-slide,
        .reader-viewport.no-anim .page-slide > * { transition: none !important; }

        /* --- 文字與排版 --- */
        p { 
            font-size: clamp(1.05rem, 2vmin, 1.25rem); 
            line-height: 1.85; 
            text-align: justify; 
            margin: 0;
            font-weight: 300; 
            color: var(--text-color);
        }
        
        h1, h2, h3 { margin: 0; font-weight: 600; line-height: 1.3; color: var(--accent-color); }
        .article-heading { margin-top: 5px; }
        .article-heading[data-level="1"] { font-size: 1.6rem; border-left: 3px solid var(--accent-color); padding-left: 15px; }
        .article-heading[data-level="2"] { font-size: 1.3rem; opacity: 0.85; }

        /* --- 圖片 (嚴格限制不超出) --- */
        figure { margin: 0; padding: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        figure img { 
            max-width: 100%; 
            /* 圖片高度自動計算：總高度 - 上下邊距 - 標題高度(預估) */
            max-height: 100%; 
            height: auto; 
            object-fit: contain;
            border-radius: 2px; 
            opacity: 0; transition: opacity 0.8s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); /* 輕微陰影增加立體感 */
        }
        figure img.loaded { opacity: 1; }
        
        /* Lightbox */
        #lightbox {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(var(--bg-rgb), 0.95); /* 使用背景色但不完全透明 */
            z-index: 3000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: 0.4s var(--ease-fluid);
            backdrop-filter: blur(10px);
        }
        #lightbox.active { opacity: 1; visibility: visible; }
        #lightbox img { 
            max-width: 90vw; max-height: 90vh; 
            transform: scale(0.95); transition: 0.5s var(--ease-bounce); 
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); 
        }
        #lightbox.active img { transform: scale(1); }

        .loading-placeholder { width: 100%; height: 200px; background: var(--placeholder-bg); display: flex; align-items: center; justify-content: center; opacity: 0.3; }

        /* --- 底部導航 & 隱形滑動條 --- */
        .pagination { 
            position: fixed; bottom: 30px; width: 100%; 
            display: flex; justify-content: center; align-items: center; 
            gap: 40px; font-family: sans-serif; font-size: 0.85rem; letter-spacing: 1px;
            z-index: 10; pointer-events: none; 
            transition: opacity 0.3s;
        }
        .pagination > * { pointer-events: auto; }
        .nav-btn { cursor: none; opacity: 0.2; padding: 15px; border: none; background: none; color: inherit; font-size: 0.8rem; font-weight: 600; transition: 0.3s; }
        .nav-btn:hover { opacity: 1; transform: scale(1.1); }
        .nav-btn:disabled { opacity: 0; pointer-events: none; }

        .page-indicator { 
            cursor: none; padding: 8px 16px; border-radius: 20px; 
            transition: transform 0.3s var(--ease-bounce), background 0.3s; 
            font-weight: 500; opacity: 0.6;
        }
        .page-indicator:hover { opacity: 1; transform: scale(1.1); background: rgba(128,128,128,0.05); }

        /* 隱形滑動條容器 */
        #progress-container {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            width: 70%; max-width: 300px; height: 60px;
            z-index: 500; 
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; pointer-events: none;
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        #progress-container.active { opacity: 1; visibility: visible; pointer-events: auto; }

        /* 自定義極簡 Range Input */
        .custom-range {
            -webkit-appearance: none; width: 100%; height: 2px; 
            background: rgba(128,128,128,0.2);
            outline: none; cursor: none;
        }
        /* 滑塊 Thumb - 只有這個可見 */
        .custom-range::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 12px; height: 12px; border-radius: 50%;
            background: var(--accent-color); 
            cursor: none;
            transition: transform 0.2s var(--ease-bounce);
            box-shadow: 0 0 0 4px var(--bg-color); /* 模擬空心效果 */
        }
        .custom-range::-webkit-slider-thumb:active { transform: scale(1.5); }
        
        .progress-float-val {
            position: absolute; top: -30px; 
            font-size: 1.2rem; font-weight: 600; 
            opacity: 0; transition: 0.2s;
            transform: translateY(10px);
        }
        #progress-container.active .progress-float-val { opacity: 1; transform: translateY(0); }

        /* 退出與提示 */
        .toast-msg {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            color: var(--text-color); padding: 8px 16px;
            font-size: 0.85rem; letter-spacing: 1px; opacity: 0; transition: opacity 0.5s; 
            pointer-events: none; z-index: 200;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(5px);
            border-radius: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .toast-msg.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
        
        #exit-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); display: flex; align-items: center; justify-content: center;
            z-index: 999; opacity: 0; visibility: hidden; transition: 0.6s var(--ease-fluid);
        }
        #exit-overlay.active { opacity: 1; visibility: visible; }
        #exit-text { font-size: 1.2rem; letter-spacing: 8px; opacity: 0; transform: translateY(20px); transition: 0.6s 0.2s var(--ease-fluid); }
        #exit-overlay.active #exit-text { opacity: 1; transform: translateY(0); }

        /* RWD */
        @media (max-width: 1024px) { 
            .cursor-dot, .cursor-circle { display: none; }
            :root { --page-margin-top: 60px; --page-margin-bottom: 70px; }
            .reader-viewport { width: 88%; } 
            .page-slide { padding: 0 0px; gap: 20px; }
            .pagination { bottom: 25px; }
            .top-controls { top: 20px; left: 20px; }
            .menu-trigger { top: 20px; right: 20px; }
            .page-slide.active > * { transition-delay: 0s !important; } /* 手機版為了性能減少逐個動畫 */
        }
    </style>
</head>
<body class="js-loading">
    <div class="cursor-dot"></div>
    <div class="cursor-circle"></div>
    
    <div id="exit-overlay"><span id="exit-text">RETURN</span></div>
    <div class="toast-msg" id="swipe-hint">再次滑動以返回</div>

    <div id="lightbox" onclick="closeLightbox()">
        <img id="lightbox-img" src="" alt="preview">
    </div>

    <div class="menu-overlay" id="menu-overlay">
        <div class="menu-item interactable" onclick="goBack()">Return</div>
        <div class="menu-item interactable" onclick="toggleMenu()">Resume</div>
    </div>

    <!-- 隱形進度條 -->
    <div id="progress-container">
        <div class="progress-float-val" id="slider-val">1</div>
        <input type="range" min="1" max="1" value="1" class="custom-range interactable" id="page-slider">
    </div>

    <div id="app-container">
        <main class="main-content">
            <div class="top-controls">
                <button class="icon-btn interactable" onclick="goBack()" aria-label="返回">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
            </div>
            
            <div class="menu-trigger interactable" onclick="toggleMenu()">
                <div class="hamburger" id="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <div class="reader-viewport" id="viewport" aria-live="polite">
                <!-- Content injected here -->
            </div>

            <nav class="pagination" role="navigation">
                <button class="nav-btn interactable" id="prev-btn">PREV</button>
                <div class="page-indicator interactable" id="page-num">1 / 1</div>
                <button class="nav-btn interactable" id="next-btn">NEXT</button>
            </nav>
        </main>
    </div>

    <script>
        const viewport = document.getElementById('viewport');
        const pageNum = document.getElementById('page-num');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        
        // Progress UI
        const progressContainer = document.getElementById('progress-container');
        const pageSlider = document.getElementById('page-slider');
        const sliderVal = document.getElementById('slider-val');

        // Visuals
        const cursorDot = document.querySelector('.cursor-dot');
        const cursorCircle = document.querySelector('.cursor-circle');
        const menuOverlay = document.getElementById('menu-overlay');
        const hamburgerIcon = document.getElementById('hamburger-icon');
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const swipeHint = document.getElementById('swipe-hint');
        const exitOverlay = document.getElementById('exit-overlay');

        let currentPage = 0, totalPages = 0, pages = [];
        let contentElements = []; 
        let currentArticleId = null;

        let touchStartX = 0, touchMoveX = 0, isSwiping = false;
        let lastPageSwipeCount = 0; 
        let swipeResetTimer;
        let isMenuOpen = false;
        let isSliderDragging = false;

        // --- 1. Fetch & Layout ---
        async function fetchArticleContent(id) {
            if (!id) throw new Error("ID missing");
            currentArticleId = id;
            const response = await fetch(`./article/${id}.json`);
            if (!response.ok) throw new Error("Fetch failed");
            return await response.json();
        }

        async function layoutArticle(content) {
            document.title = content.title;
            // 先清理 DOM
            contentElements = [];
            
            // 標題元素
            const titleWrap = document.createElement('div');
            titleWrap.className = 'title-wrapper';
            titleWrap.innerHTML = `<h1>${content.title}</h1><div style="margin-top:15px; font-size:0.8rem; opacity:0.5; letter-spacing:1px;">${content.date}</div>`;
            contentElements.push({ type: 'title', el: titleWrap, isTitle: true });

            // 內容解析
            for (const item of content.paragraphs) {
                let el;
                if (typeof item === 'string') {
                    el = document.createElement('p');
                    el.className = 'interactable-text';
                    el.innerText = item;
                    el.onclick = () => copyText(el);
                    contentElements.push({ type: 'text', el: el, index: contentElements.length });
                } else if (item.type === 'image') {
                    el = document.createElement('figure');
                    const ph = document.createElement('div');
                    ph.className = 'loading-placeholder interactable';
                    ph.dataset.src = item.src;
                    ph.dataset.alt = item.alt || '';
                    el.appendChild(ph);
                    if (item.caption) {
                        const cap = document.createElement('figcaption');
                        cap.innerText = item.caption;
                        cap.style.cssText = "margin-top:10px; font-size:0.8rem; opacity:0.6;";
                        el.appendChild(cap);
                    }
                    contentElements.push({ type: 'image', el: el, index: contentElements.length });
                } else if (item.type === 'header') {
                    el = document.createElement(item.level === 1 ? 'h2' : 'h3');
                    el.className = 'article-heading interactable-text';
                    el.innerText = item.text;
                    el.dataset.level = item.level;
                    contentElements.push({ type: 'header', el: el, index: contentElements.length });
                }
            }

            distributeContentToPages();
        }

        function distributeContentToPages() {
            pages = []; 
            viewport.innerHTML = '';
            
            const vH = viewport.clientHeight; // 這裡的高度已經被 CSS calc() 限制住了
            if (vH <= 0) return; 

            // 虛擬測量容器
            const tempDiv = document.createElement('div');
            tempDiv.style.cssText = `visibility:hidden; position:absolute; width:${viewport.clientWidth}px; left:0; top:0; padding:0 40px;`;
            document.body.appendChild(tempDiv);

            // 第一頁
            let currentDiv = createPageDiv(0, true);
            let currentHeight = 0;
            const gap = 28; // CSS .page-slide gap
            pages.push(currentDiv);
            
            for (let i = 0; i < contentElements.length; i++) {
                const item = contentElements[i];
                const el = item.el.cloneNode(true); 
                
                // 恢復事件綁定
                if(item.type === 'text') el.onclick = () => copyText(el);
                if(item.type === 'image') {
                    // 重置圖片狀態
                    const ph = el.querySelector('.loading-placeholder');
                    if(ph) { ph.dataset.loading = 'false'; ph.innerHTML = ''; }
                }

                // 測量高度
                tempDiv.innerHTML = '';
                tempDiv.appendChild(el);
                const elH = tempDiv.clientHeight;

                // 標題單獨或置頂
                if (i === 0) {
                     currentDiv.appendChild(el);
                     currentDiv.dataset.startIndex = 0; 
                     currentHeight += elH + gap;
                     continue;
                }

                // 判斷換頁
                if (currentHeight + elH + gap > vH) {
                    currentDiv = createPageDiv(pages.length);
                    currentDiv.dataset.startIndex = item.index; 
                    pages.push(currentDiv);
                    currentDiv.appendChild(el);
                    currentHeight = elH + gap;
                } else {
                    if (!currentDiv.dataset.startIndex) currentDiv.dataset.startIndex = item.index;
                    currentDiv.appendChild(el);
                    currentHeight += (elH + gap);
                }
            }
            
            document.body.removeChild(tempDiv);
            pages.forEach(p => viewport.appendChild(p));
            totalPages = pages.length;

            pageSlider.max = totalPages;
            restoreProgress(); // 恢復進度
            bindCursorEvents();
        }

        // --- 2. Progress Logic ---
        function saveProgress() {
            if (!currentArticleId || pages.length === 0) return;
            const startIndex = pages[currentPage].dataset.startIndex || 0;
            localStorage.setItem(`article_progress_${currentArticleId}`, startIndex);
        }

        function restoreProgress() {
            const savedIndex = localStorage.getItem(`article_progress_${currentArticleId}`);
            if (savedIndex !== null) {
                const idx = parseInt(savedIndex);
                let targetPage = 0;
                for (let i = 0; i < pages.length; i++) {
                    const pStart = parseInt(pages[i].dataset.startIndex || 0);
                    if (pStart <= idx) targetPage = i; else break;
                }
                currentPage = targetPage;
            } else {
                currentPage = 0;
            }
            updatePage(false); // 初始載入不使用瞬間模式
        }

        // --- 3. Navigation & Animations ---
        function createPageDiv(index, isTitle = false) { 
            const div = document.createElement('div'); 
            div.className = 'page-slide'; 
            if (isTitle) div.classList.add('title-slide'); 
            return div; 
        }

        function changePage(dir) { 
            const newPage = currentPage + dir; 
            if (newPage >= 0 && newPage < totalPages) { 
                currentPage = newPage; 
                // 手動點擊時，確保不是 "instant" 模式，讓 CSS 動畫生效
                updatePage(false); 
            }
        }

        // 核心更新函數
        function updatePage(instant = false) { 
            pages.forEach((page, index) => { 
                // 清理舊狀態
                page.classList.remove('active', 'prev-page');
                
                // 計算相對位置，用於 slider 拖動時的即時計算
                const offset = index - currentPage;

                if (instant) {
                    // Slider 拖動模式：使用 inline styles 實現無延遲跟隨
                    page.style.transform = `translateX(${offset * 60}px) scale(${1 - Math.abs(offset)*0.05})`; 
                    page.style.opacity = index === currentPage ? 1 : (Math.abs(offset) < 2 ? 0.1 : 0);
                } else {
                    // 手動/自動模式：清除 inline styles，讓 CSS classes 接管
                    page.style.transform = ''; 
                    page.style.opacity = '';
                    
                    if (index === currentPage) {
                        page.classList.add('active');
                    } else if (index < currentPage) {
                        page.classList.add('prev-page'); // 讓舊頁面往左退場
                    }
                    // index > currentPage 保持默認 (右側待機)
                }
            }); 
            
            pageNum.innerText = `${currentPage + 1} / ${totalPages}`; 
            
            // 按鈕狀態
            prevBtn.disabled = (currentPage === 0); 
            nextBtn.disabled = (currentPage === totalPages - 1); 
            
            if(!instant) {
                saveProgress();
                lazyLoadImages();
            }
        }

        // --- 4. Slider Interaction (Invisible & Auto-hide) ---
        pageNum.addEventListener('click', (e) => {
            e.stopPropagation();
            progressContainer.classList.add('active');
            pageSlider.value = currentPage + 1;
            sliderVal.innerText = currentPage + 1;
        });
        
        // 滑動中 (Input Event)
        pageSlider.addEventListener('input', (e) => {
            isSliderDragging = true;
            const val = parseInt(e.target.value);
            sliderVal.innerText = val;
            
            if (currentPage !== val - 1) {
                currentPage = val - 1;
                viewport.classList.add('no-anim'); // 暫時關閉 CSS transition 以便跟手
                updatePage(true); // true = instant mode
            }
        });

        // 鬆手後 (Change Event)
        pageSlider.addEventListener('change', () => {
            isSliderDragging = false;
            viewport.classList.remove('no-anim'); 
            
            // 讓 CSS 接管最終位置
            updatePage(false); 
            
            // 立即隱藏滑動條
            progressContainer.classList.remove('active');
        });

        // --- 5. Image & Menu ---
        function openLightbox(src) {
            lightboxImg.src = src;
            lightbox.classList.add('active');
        }
        function closeLightbox() {
            lightbox.classList.remove('active');
            setTimeout(() => { lightboxImg.src = ''; }, 300);
        }

        function lazyLoadImages() {
            // 預加載前後頁
            [currentPage-1, currentPage, currentPage+1].forEach(idx => {
                if (idx < 0 || idx >= totalPages) return;
                pages[idx].querySelectorAll('.loading-placeholder').forEach(ph => {
                    if (ph.dataset.loading === 'true') return;
                    ph.dataset.loading = 'true';
                    
                    const img = document.createElement('img');
                    img.src = ph.dataset.src;
                    img.alt = ph.dataset.alt;
                    img.className = 'interactable';
                    img.onload = () => {
                        img.classList.add('loaded');
                        img.onclick = (e) => { e.stopPropagation(); openLightbox(img.src); };
                        if(ph.parentNode) ph.parentNode.replaceChild(img, ph);
                        bindCursorEvents();
                    };
                    img.onerror = () => { ph.dataset.loading = 'false'; };
                });
            });
        }

        function toggleMenu() {
            isMenuOpen = !isMenuOpen;
            hamburgerIcon.classList.toggle('active', isMenuOpen);
            menuOverlay.classList.toggle('open', isMenuOpen);
        }

        async function copyText(el) { try { await navigator.clipboard.writeText(el.innerText); } catch {} }

        function goBack() {
            document.body.style.opacity = '0';
            setTimeout(() => { window.location.href = './articles.html'; }, 500);
        }

        // --- 6. Initialization ---
        async function initialize() {
            try {
                const params = new URLSearchParams(window.location.search);
                const articleId = params.get('id');
                const content = await fetchArticleContent(articleId);
                await document.fonts.ready;
                layoutArticle(content);
                
                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        if (contentElements.length > 0) distributeContentToPages();
                    }, 300);
                });
                
                initInputs();
            } catch (error) { console.error(error); } 
            finally { document.body.classList.remove('js-loading'); }
        }

        function initInputs() {
            prevBtn.addEventListener('click', () => changePage(-1)); 
            nextBtn.addEventListener('click', () => changePage(1)); 
            document.addEventListener('keydown', (e) => { 
                if (e.key === 'ArrowLeft') changePage(-1); 
                else if (e.key === 'ArrowRight') changePage(1); 
                else if (e.key === 'Escape') { closeLightbox(); }
            });

            // Swipe Logic
            if (window.matchMedia("(hover: none) or (max-width: 1024px)").matches) {
                viewport.addEventListener('touchstart', e => {
                    touchStartX = e.touches[0].clientX;
                    touchMoveX = touchStartX;
                    isSwiping = true;
                }, {passive: true});

                viewport.addEventListener('touchmove', e => {
                    if (!isSwiping) return;
                    touchMoveX = e.touches[0].clientX;
                    const delta = touchMoveX - touchStartX;
                    const page = pages[currentPage];
                    if (!page) return;
                    
                    let tx = delta;
                    if ((currentPage === 0 && delta > 0) || (currentPage === totalPages-1 && delta < 0)) tx *= 0.3; // Resistance
                    
                    // Direct manipulation for responsiveness
                    page.style.transform = `translateX(${tx}px)`;
                }, {passive: true});

                viewport.addEventListener('touchend', e => {
                    if (!isSwiping) return;
                    isSwiping = false;
                    const delta = touchMoveX - touchStartX;
                    const page = pages[currentPage];
                    
                    // Clear manual transform so CSS can animate the snap
                    page.style.transform = '';

                    if (delta < -60) { 
                        if (currentPage < totalPages - 1) { changePage(1); resetSwipeExit(); }
                        else handleSwipeExit(); 
                    } else if (delta > 60) { 
                        if (currentPage === 0) handleSwipeExit(); 
                        else { changePage(-1); resetSwipeExit(); }
                    } else {
                        updatePage(false); // Snap back
                    }
                }, {passive: true});
            }

            // Cursor Logic
            if (!window.matchMedia("(hover: none) or (max-width: 1024px)").matches) {
                let mouseX = 0, mouseY = 0;
                let circleX = 0, circleY = 0;
                
                document.addEventListener('mousemove', e => { 
                    mouseX = e.clientX; mouseY = e.clientY;
                    cursorDot.style.transform = `translate(${mouseX}px, ${mouseY}px) translate(-50%, -50%)`;
                });

                // Smooth follower loop
                function animateCursor() {
                    const dx = mouseX - circleX;
                    const dy = mouseY - circleY;
                    circleX += dx * 0.15; // Delay factor
                    circleY += dy * 0.15;
                    cursorCircle.style.transform = `translate(${circleX}px, ${circleY}px) translate(-50%, -50%)`;
                    requestAnimationFrame(animateCursor);
                }
                animateCursor();
                
                document.addEventListener('mousedown', () => document.body.classList.add('is-clicking'));
                document.addEventListener('mouseup', () => document.body.classList.remove('is-clicking'));
            }
        }
        
        function bindCursorEvents() {
            if (window.matchMedia("(hover: none) or (max-width: 1024px)").matches) return;
            document.querySelectorAll('.interactable, .interactable-text').forEach(el => {
                el.onmouseenter = () => document.body.classList.add('is-hovering');
                el.onmouseleave = () => document.body.classList.remove('is-hovering');
            });
        }

        function handleSwipeExit() {
            clearTimeout(swipeResetTimer);
            lastPageSwipeCount++;
            if (lastPageSwipeCount === 1) {
                swipeHint.classList.add('show');
                updatePage(false);
                swipeResetTimer = setTimeout(resetSwipeExit, 3000);
            } else if (lastPageSwipeCount >= 2) {
                swipeHint.classList.remove('show');
                exitOverlay.classList.add('active');
                setTimeout(goBack, 800);
            }
        }
        function resetSwipeExit() {
            lastPageSwipeCount = 0;
            swipeHint.classList.remove('show');
        }

        window.addEventListener('load', initialize);
    </script>
</body>
</html>
