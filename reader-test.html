<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Article</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-color: #ffffff; 
            --text-color: #1a1a1a; 
            --accent-color: #000000; 
            --placeholder-bg: #f0f0f0; 
        }
        @media (prefers-color-scheme: dark) { 
            :root { --bg-color: #000000; --text-color: #e5e5e5; --accent-color: #ffffff; --placeholder-bg: #1c1c1e; } 
        }

        body.js-loading { opacity: 0; visibility: hidden; }
        body { 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            font-family: 'Noto Serif TC', serif; 
            margin: 0; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden; 
            transition: opacity 0.8s ease; 
        }
        
        /* 全局隱藏原生鼠標 */
        * { cursor: none !important; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        @media (hover: none) or (max-width: 768px) { * { cursor: auto !important; } }

        /* 佈局容器 */
        #app-container { display: flex; width: 100%; height: 100%; position: relative; }
        .main-content { flex: 1; position: relative; height: 100%; display: flex; flex-direction: column; overflow: hidden; }

        /* --- 新版自定義鼠標 (重做) --- */
        .cursor-dot, .cursor-circle {
            position: fixed; top: 0; left: 0; pointer-events: none; z-index: 99999; border-radius: 50%;
            transform: translate(-50%, -50%); transition: opacity 0.3s;
        }
        /* 中心實心點 */
        .cursor-dot { width: 8px; height: 8px; background-color: var(--accent-color); }
        /* 外圍跟隨圈 */
        .cursor-circle { 
            width: 40px; height: 40px; border: 1px solid var(--accent-color); 
            transition: width 0.2s, height 0.2s, transform 0.1s ease-out, background-color 0.2s; 
            opacity: 0.6;
        }
        /* 鼠標互動狀態 */
        body.is-hovering .cursor-circle { width: 60px; height: 60px; background-color: rgba(128,128,128,0.1); border-color: transparent; }
        body.is-clicking .cursor-dot { transform: translate(-50%, -50%) scale(0.8); }
        body.is-clicking .cursor-circle { transform: translate(-50%, -50%) scale(0.9); }

        /* 頂部按鈕與漢堡菜單 */
        .top-controls { position: fixed; top: 30px; left: 30px; z-index: 100; pointer-events: none; }
        .menu-trigger { position: fixed; top: 30px; right: 30px; z-index: 2100; pointer-events: auto; } /* z-index 高於 overlay */
        
        .icon-btn { opacity: 0.5; transition: 0.3s; border: none; background: none; padding: 10px; display: flex; align-items: center; justify-content: center; pointer-events: auto; }
        .icon-btn:hover { opacity: 1; transform: scale(1.1); }
        .icon-btn svg { width: 24px; height: 24px; fill: var(--text-color); }

        /* 漢堡圖標樣式 */
        .hamburger { width: 30px; height: 20px; position: relative; cursor: none; display: flex; flex-direction: column; justify-content: space-between; }
        .hamburger span { display: block; width: 100%; height: 2px; background-color: var(--text-color); transition: 0.3s; }
        .hamburger.active span:nth-child(1) { transform: translateY(9px) rotate(45deg); }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: translateY(-9px) rotate(-45deg); }

        /* 全屏漢堡菜單 Overlay */
        .menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: 0.4s ease;
        }
        .menu-overlay.open { opacity: 1; visibility: visible; }
        .menu-item { font-size: 2rem; margin: 20px 0; font-weight: 300; opacity: 0; transform: translateY(20px); transition: 0.4s; cursor: none; }
        .menu-overlay.open .menu-item { opacity: 1; transform: translateY(0); }
        .menu-item:hover { color: var(--accent-color); letter-spacing: 2px; }

        /* 閱讀視口 (修正版：自適應高度) */
        .reader-viewport { 
            flex: 1; 
            width: 100%; 
            max-width: 800px; 
            /* 使用 calc 確保高度適應屏幕，預留頭尾空間，防止溢出 */
            height: calc(100vh - 140px);
            margin: 70px auto; 
            position: relative; 
            touch-action: pan-y; 
            /* 邊框除錯用: border: 1px solid red; */
        }
        
        .page-slide { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 0 40px; 
            opacity: 0; pointer-events: none; transform: translateX(30px); 
            transition: opacity 0.4s ease, transform 0.4s ease; 
            display: flex; flex-direction: column; justify-content: flex-start; /* 改為從頂部開始排列 */
            gap: 25px; 
            overflow: hidden; /* 防止內容溢出 slide 容器 */
        }
        .page-slide.active { opacity: 1; pointer-events: auto; transform: translateX(0); }
        .page-slide.is-swiping { transition: none; }
        
        /* 首頁標題垂直置中例外 */
        .page-slide.title-slide { justify-content: center; }

        /* 文字樣式 */
        p { 
            font-size: clamp(1.1rem, 2.2vmin, 1.35rem); 
            line-height: 1.8; 
            text-align: justify; 
            margin: 0;
            font-weight: 400; 
            overflow-wrap: break-word; 
            transform-origin: left center; 
            transition: transform 0.2s;
        }
        p:hover { transform: scale(1.01); }
        
        /* 標題樣式 */
        h1, h2, h3 { margin: 0; font-weight: 600; line-height: 1.4; }
        .article-heading { margin-top: 10px; margin-bottom: 10px; }
        .article-heading[data-level="1"] { font-size: 1.8rem; border-left: 4px solid var(--accent-color); padding-left: 15px; font-weight: 700; }
        .article-heading[data-level="2"] { font-size: 1.4rem; opacity: 0.9; padding-left: 5px; font-weight: 600; }

        /* 圖片與燈箱 */
        figure { margin: 0; padding: 0; width: 100%; display: flex; flex-direction: column; align-items: center; }
        figure img { 
            max-width: 100%; max-height: 60vh; height: auto; 
            border-radius: 4px; opacity: 0; transition: opacity 0.5s ease, transform 0.3s;
            cursor: none; 
        }
        figure img.loaded { opacity: 1; }
        figure img:hover { transform: scale(1.02); }
        
        /* Lightbox */
        #lightbox {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 3000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: 0.3s;
            backdrop-filter: blur(5px);
        }
        #lightbox.active { opacity: 1; visibility: visible; }
        #lightbox img { max-width: 95vw; max-height: 95vh; object-fit: contain; transform: scale(0.9); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1); box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #lightbox.active img { transform: scale(1); }

        .loading-placeholder { width: 100%; height: 250px; background-color: var(--placeholder-bg); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--text-color); opacity: 0.5; font-size: 0.9rem; }
        .loading-placeholder.pulsing { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* 底部頁碼 */
        .pagination { position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: center; align-items: center; gap: 40px; font-family: sans-serif; font-size: 0.9rem; user-select: none; z-index: 10; pointer-events: none; }
        .pagination > * { pointer-events: auto; }
        .nav-btn { opacity: 0.3; padding: 10px; border: none; background: none; color: inherit; font-size: inherit; }
        .nav-btn:hover { opacity: 1; }
        .nav-btn:disabled { opacity: 0.05; }

        /* 退出提示與遮罩 */
        .toast-msg {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: var(--accent-color); color: var(--bg-color); padding: 8px 16px; border-radius: 20px;
            font-size: 0.9rem; opacity: 0; transition: opacity 0.3s; pointer-events: none;
            z-index: 200;
        }
        .toast-msg.show { opacity: 1; }
        #exit-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); display: flex; align-items: center; justify-content: center;
            z-index: 999; opacity: 0; visibility: hidden; transition: 0.5s;
        }
        #exit-overlay.active { opacity: 1; visibility: visible; }
        #exit-overlay span { font-size: 1.5rem; letter-spacing: 5px; animation: glow 1.5s infinite alternate; }
        @keyframes glow { from { text-shadow: 0 0 5px var(--text-color); opacity: 0.5; } to { text-shadow: 0 0 20px var(--text-color); opacity: 1; } }

        /* RWD 調整 */
        @media (max-width: 1024px) { 
            .cursor-dot, .cursor-circle { display: none; } /* 手機隱藏自訂鼠標 */
            .reader-viewport { 
                /* 手機版上下間距調整 */
                height: calc(100vh - 120px);
                margin: 60px auto; 
                width: 90%; 
            } 
            .page-slide { padding: 0 5px; gap: 20px; }
            .pagination { bottom: 20px; }
            .top-controls { top: 20px; left: 20px; }
            .menu-trigger { top: 20px; right: 20px; }
        }
    </style>
</head>
<body class="js-loading">
    <!-- 新版自定義鼠標 -->
    <div class="cursor-dot"></div>
    <div class="cursor-circle"></div>
    
    <!-- 退出動畫層 -->
    <div id="exit-overlay"><span id="exit-text">正在返回...</span></div>
    <div class="toast-msg" id="swipe-hint">再次滑動以返回列表</div>

    <!-- 圖片燈箱 -->
    <div id="lightbox" onclick="closeLightbox()">
        <img id="lightbox-img" src="" alt="preview">
    </div>

    <!-- 漢堡菜單全屏層 -->
    <div class="menu-overlay" id="menu-overlay">
        <div class="menu-item interactable" onclick="goBack()">返回列表</div>
        <div class="menu-item interactable" onclick="toggleMenu()">繼續閱讀</div>
    </div>

    <div id="app-container">
        <!-- 主內容區 -->
        <main class="main-content">
            <div class="top-controls">
                <button class="icon-btn interactable" onclick="goBack()" aria-label="返回">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
            </div>
            
            <!-- 漢堡菜單按鈕 -->
            <div class="menu-trigger interactable" onclick="toggleMenu()">
                <div class="hamburger" id="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <!-- 閱讀視口 -->
            <div class="reader-viewport" id="viewport" aria-live="polite">
                <div class="loading-placeholder pulsing"></div>
            </div>

            <nav class="pagination" role="navigation">
                <button class="nav-btn interactable" id="prev-btn">PREV</button>
                <div class="page-indicator" id="page-num">1 / 1</div>
                <button class="nav-btn interactable" id="next-btn">NEXT</button>
            </nav>
        </main>
    </div>

    <script>
        const viewport = document.getElementById('viewport');
        const pageNum = document.getElementById('page-num');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        
        // Cursor Elements
        const cursorDot = document.querySelector('.cursor-dot');
        const cursorCircle = document.querySelector('.cursor-circle');

        // Menu Elements
        const menuOverlay = document.getElementById('menu-overlay');
        const hamburgerIcon = document.getElementById('hamburger-icon');

        // Lightbox
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');

        // Hints & Swipe
        const swipeHint = document.getElementById('swipe-hint');
        const exitOverlay = document.getElementById('exit-overlay');

        let currentPage = 0, totalPages = 0, pages = [];
        let articleData = null;
        let touchStartX = 0, touchMoveX = 0, isSwiping = false;
        let lastPageSwipeCount = 0; 
        let swipeResetTimer;
        let isMenuOpen = false;

        // --- 1. Fetch & Layout ---
        async function fetchArticleContent(id) {
            if (!id) throw new Error("ID missing");
            const response = await fetch(`./article/${id}.json`);
            if (!response.ok) throw new Error("Fetch failed");
            return await response.json();
        }

        async function layoutArticle(content) {
            articleData = content;
            document.title = content.title;
            viewport.innerHTML = `<div class="loading-placeholder pulsing" style="margin: auto;"></div>`;
            pages = []; currentPage = 0;

            // 重要：這裡獲取的高度現在受到 CSS calc() 的限制，防止溢出
            const vH = viewport.clientHeight; 
            const vW = viewport.clientWidth;
            if (vH <= 0) return;

            // Title Page
            const titlePage = createPageDiv(0, true);
            titlePage.innerHTML = `<h1>${content.title}</h1><div class="meta" style="margin-top:10px; opacity:0.6;">${content.date}</div>`;
            pages.push(titlePage);

            // Content Pages
            let contentPageIndex = 1;
            let currentDiv = createPageDiv(1);
            pages.push(currentDiv);

            // Layout Calculation
            const tempDiv = document.createElement('div');
            const style = getComputedStyle(currentDiv);
            const pGap = parseFloat(style.gap) || 25;
            tempDiv.style.cssText = `visibility:hidden; position:absolute; width:${vW - (parseFloat(style.paddingLeft)*2)}px; left:0; top:0;`;
            document.body.appendChild(tempDiv);

            let currentH = 0;

            try {
                for (const item of content.paragraphs) {
                    let el;

                    if (typeof item === 'string') {
                        el = document.createElement('p');
                        el.className = 'interactable-text';
                        el.innerText = item;
                        el.onclick = () => copyText(el);
                    } else if (item.type === 'image') {
                        el = document.createElement('figure');
                        const ph = document.createElement('div');
                        ph.className = 'loading-placeholder pulsing interactable';
                        ph.dataset.src = item.src;
                        ph.dataset.alt = item.alt || '';
                        el.appendChild(ph);
                        if (item.caption) {
                            const cap = document.createElement('figcaption');
                            cap.innerText = item.caption;
                            el.appendChild(cap);
                        }
                    } else if (item.type === 'header') {
                        el = document.createElement(item.level === 1 ? 'h2' : 'h3');
                        el.className = 'article-heading interactable-text';
                        el.dataset.level = item.level;
                        el.innerText = item.text;
                    }

                    if (!el) continue;

                    tempDiv.innerHTML = '';
                    tempDiv.appendChild(el.cloneNode(true));
                    const elH = tempDiv.clientHeight;

                    // 判斷是否超出視口高度，若超出則換頁
                    if (currentH > 0 && (currentH + elH + pGap > vH)) {
                        contentPageIndex++;
                        currentDiv = createPageDiv(contentPageIndex);
                        pages.push(currentDiv);
                        currentH = 0;
                    }

                    currentDiv.appendChild(el);
                    currentH += (elH + pGap);
                }
            } finally {
                document.body.removeChild(tempDiv);
            }

            viewport.innerHTML = '';
            pages.forEach(p => viewport.appendChild(p));
            totalPages = pages.length;

            updatePage();
            bindCursorEvents();
            lazyLoadImages();
        }

        // --- 2. Menu Logic ---
        function toggleMenu() {
            isMenuOpen = !isMenuOpen;
            hamburgerIcon.classList.toggle('active', isMenuOpen);
            menuOverlay.classList.toggle('open', isMenuOpen);
        }

        // --- 3. Image Lightbox & Lazy Load ---
        function openLightbox(src) {
            lightboxImg.src = src;
            lightbox.classList.add('active');
        }
        function closeLightbox() {
            lightbox.classList.remove('active');
            setTimeout(() => { lightboxImg.src = ''; }, 300);
        }

        function lazyLoadImages() {
            const range = [currentPage-1, currentPage, currentPage+1, currentPage+2, currentPage+3];
            range.forEach(idx => {
                if (idx < 0 || idx >= totalPages) return;
                const page = pages[idx];
                page.querySelectorAll('.loading-placeholder[data-src]').forEach(ph => {
                    if (ph.dataset.loading === 'true') return;
                    ph.dataset.loading = 'true';
                    
                    const img = document.createElement('img');
                    img.src = ph.dataset.src;
                    img.alt = ph.dataset.alt;
                    img.className = 'interactable';
                    
                    img.onload = () => {
                        img.classList.add('loaded');
                        img.onclick = (e) => { e.stopPropagation(); openLightbox(img.src); };
                        ph.parentNode.replaceChild(img, ph);
                        bindCursorEvents(); 
                    };
                    
                    img.onerror = () => {
                        // 簡單重試邏輯
                        setTimeout(() => { ph.dataset.loading = 'false'; }, 2000);
                    };
                });
            });
        }

        // --- 4. General Helpers ---
        function createPageDiv(index, isTitle = false) { 
            const div = document.createElement('div'); 
            div.className = 'page-slide'; 
            if (isTitle) div.classList.add('title-slide'); 
            div.dataset.index = index; 
            return div; 
        }

        function changePage(dir) { 
            const newPage = currentPage + dir; 
            if (newPage >= 0 && newPage < totalPages) { 
                currentPage = newPage; 
                updatePage(); 
            }
        }

        function updatePage() { 
            pages.forEach((page, index) => { 
                page.style.transform = ''; 
                page.classList.remove('is-swiping'); 
                page.classList.toggle('active', index === currentPage); 
            }); 
            pageNum.innerText = `${currentPage + 1} / ${totalPages}`; 
            prevBtn.disabled = (currentPage === 0); 
            nextBtn.disabled = (currentPage === totalPages - 1); 
            lazyLoadImages();
        }

        async function copyText(el) { try { await navigator.clipboard.writeText(el.innerText); } catch {} }

        function goBack() {
            document.body.style.opacity = '0';
            setTimeout(() => { window.location.href = './articles.html'; }, 500);
        }

        // --- 5. Initialization ---
        async function initialize() {
            try {
                const params = new URLSearchParams(window.location.search);
                const articleId = params.get('id');
                const content = await fetchArticleContent(articleId);
                await document.fonts.ready;
                await layoutArticle(content);
                
                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        if (articleData) layoutArticle(articleData);
                    }, 250);
                });
                
                initInputs();
            } catch (error) {
                console.error("Init failed", error);
            } finally {
                document.body.classList.remove('js-loading');
            }
        }

        function initInputs() {
            prevBtn.addEventListener('click', () => changePage(-1)); 
            nextBtn.addEventListener('click', () => changePage(1)); 
            document.addEventListener('keydown', (e) => { 
                if (e.key === 'ArrowLeft') { prevBtn.click(); } 
                else if (e.key === 'ArrowRight') { nextBtn.click(); } 
            });

            // Swipe logic (Page Navigation)
            if (window.matchMedia("(hover: none) or (max-width: 1024px)").matches) {
                viewport.addEventListener('touchstart', e => {
                    touchStartX = e.touches[0].clientX;
                    touchMoveX = touchStartX;
                    isSwiping = true;
                    pages[currentPage]?.classList.add('is-swiping');
                }, {passive: true});

                viewport.addEventListener('touchmove', e => {
                    if (!isSwiping) return;
                    touchMoveX = e.touches[0].clientX;
                    const delta = touchMoveX - touchStartX;
                    const page = pages[currentPage];
                    if (!page) return;
                    
                    let tx = delta;
                    // 邊緣阻尼效果
                    if ((currentPage === 0 && delta > 0) || (currentPage === totalPages-1 && delta < 0)) tx *= 0.4;
                    page.style.transform = `translateX(${tx}px)`;
                }, {passive: true});

                viewport.addEventListener('touchend', e => {
                    if (!isSwiping) return;
                    isSwiping = false;
                    pages[currentPage]?.classList.remove('is-swiping');
                    const delta = touchMoveX - touchStartX;
                    
                    if (delta < -50) { // 左滑 (下一頁)
                        if (currentPage < totalPages - 1) {
                            changePage(1);
                            resetSwipeExit();
                        } else {
                            handleSwipeExit(); // 最後一頁繼續滑觸發退出
                        }
                    } else if (delta > 50) { // 右滑 (上一頁)
                        if (currentPage === 0) {
                             handleSwipeExit(); // 【新增邏輯】第一頁往前(右)滑也觸發退出
                        } else {
                            changePage(-1);
                            resetSwipeExit();
                        }
                    } else {
                        updatePage(); // 回彈
                    }
                }, {passive: true});
            }

            // Custom Cursor Logic
            if (!window.matchMedia("(hover: none) or (max-width: 1024px)").matches) {
                document.addEventListener('mousemove', e => { 
                    // 實心點直接跟隨
                    cursorDot.style.left = `${e.clientX}px`; 
                    cursorDot.style.top = `${e.clientY}px`; 
                    
                    // 外圈稍微延遲跟隨 (簡單的延遲效果)
                    setTimeout(() => {
                        cursorCircle.style.left = `${e.clientX}px`; 
                        cursorCircle.style.top = `${e.clientY}px`;
                    }, 50);
                });
                
                document.addEventListener('mousedown', () => document.body.classList.add('is-clicking'));
                document.addEventListener('mouseup', () => document.body.classList.remove('is-clicking'));
            }
        }
        
        function bindCursorEvents() {
            if (window.matchMedia("(hover: none) or (max-width: 1024px)").matches) return;
            // 給所有交互元素綁定 Hover 效果
            document.querySelectorAll('.interactable, .interactable-text').forEach(el => {
                el.removeEventListener('mouseenter', hoverOn); 
                el.removeEventListener('mouseleave', hoverOff);
                el.addEventListener('mouseenter', hoverOn);
                el.addEventListener('mouseleave', hoverOff);
            });
        }
        const hoverOn = () => document.body.classList.add('is-hovering');
        const hoverOff = () => document.body.classList.remove('is-hovering');

        function handleSwipeExit() {
            clearTimeout(swipeResetTimer);
            lastPageSwipeCount++;
            if (lastPageSwipeCount === 1) {
                swipeHint.classList.add('show');
                updatePage();
                swipeResetTimer = setTimeout(resetSwipeExit, 3000);
            } else if (lastPageSwipeCount >= 2) {
                swipeHint.classList.remove('show');
                exitOverlay.classList.add('active');
                setTimeout(goBack, 1000);
            }
        }
        function resetSwipeExit() {
            lastPageSwipeCount = 0;
            swipeHint.classList.remove('show');
        }

        window.addEventListener('load', initialize);
    </script>
</body>
</html>
