<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moments</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="./moments-data.js" defer></script>

    <style>
        :root {
            --bg-color: #ffffff; --text-color: #1a1a1a;
            --toc-bg-pc: rgba(255, 255, 255, 0.0); /* 透明背景，僅文字 */
            --accent-color: #000000;
            --ease-out: cubic-bezier(0.25, 1, 0.5, 1); /* 高級緩動曲線 */
        }
        @media (prefers-color-scheme: dark) { 
            :root { 
                --bg-color: #000000; --text-color: #e5e5e5;
                --toc-bg-pc: rgba(0, 0, 0, 0.0);
                --accent-color: #ffffff;
            } 
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html, a, button, img { cursor: none !important; user-select: none; -webkit-user-select: none; }
        body { 
            background: var(--bg-color); color: var(--text-color); 
            font-family: 'Noto Serif TC', serif; 
            height: 100vh; overflow: hidden; 
            opacity: 0; animation: fadeIn 1s var(--ease-out) forwards; 
        }

        /* --- UI Elements --- */
        #custom-cursor { position: fixed; top: 0; left: 0; width: 12px; height: 12px; background-color: var(--text-color); transform: rotate(45deg); pointer-events: none; z-index: 99999; transition: transform 0.15s var(--ease-out), width 0.2s, height 0.2s; mix-blend-mode: difference; }
        #custom-cursor.hollow { background: transparent; border: 1.5px solid var(--text-color); transform: rotate(45deg) scale(1.5); }
        
        .back-arrow { position: fixed; top: 30px; left: 30px; z-index: 200; width: 40px; height: 40px; opacity: 0.6; transition: opacity 0.3s; display: flex; align-items: center; justify-content: center; }
        .back-arrow:hover { opacity: 1; }
        .back-arrow svg { width: 24px; height: 24px; fill: var(--text-color); filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }

        /* --- Main Layout --- */
        /* scroll-snap-type 強制每次滾動一頁，保證路程一致 */
        .snap-container { height: 100vh; width: 100vw; overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth; }
        .snap-container::-webkit-scrollbar { display: none; } 
        
        .moment-section { 
            height: 100vh; width: 100vw; 
            scroll-snap-align: start; scroll-snap-stop: always; /* 確保不會飛過頭 */
            position: relative; 
            display: flex; justify-content: center; align-items: center; 
            overflow: hidden; 
        }

        /* --- Content Types --- */
        .img-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1.2s var(--ease-out); z-index: 1; }
        .img-bg.loaded { opacity: 1; }
        .bg-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.3)); z-index: 2; }
        .text-overlay { z-index: 3; position: relative; padding: 20px; max-width: 600px; text-align: center; color: #fff; transform: translateY(20px); opacity: 0; transition: all 1s var(--ease-out) 0.3s; }
        .moment-section.active .text-overlay { transform: translateY(0); opacity: 1; }
        .moment-text { font-size: 1.1rem; line-height: 1.8; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }

        .gallery-mode { background: var(--bg-color); color: var(--text-color); flex-direction: column; }
        .gallery-text { margin-bottom: 3vh; max-width: 500px; text-align: center; z-index: 4; }
        .gallery-scroll { display: flex; gap: 4vw; width: 100%; padding: 0 10vw; overflow-x: auto; scroll-snap-type: x mandatory; align-items: center; height: 60vh; z-index: 4; scrollbar-width: none; }
        .gallery-scroll::-webkit-scrollbar { display: none; }
        .gallery-item { flex: 0 0 auto; width: auto; height: 100%; scroll-snap-align: center; border-radius: 4px; overflow: hidden; position: relative; transition: transform 0.4s var(--ease-out); cursor: none; }
        .gallery-item:hover { transform: scale(1.02); }
        .gallery-item img { height: 100%; width: auto; max-width: 80vw; object-fit: cover; display: block; }

        /* --- Poem Layout (Perfect Centering) --- */
        .poem-mode { background: var(--bg-color); color: var(--text-color); }
        .poem-wrapper-outer {
            position: relative;
            width: 100%; height: 100%;
            overflow: hidden; /* Prevent scrollbars */
        }
        .poem-container {
            position: absolute;
            /* 關鍵：右側貼齊螢幕中心 (50%)，頂部貼齊螢幕中心 (50%) */
            right: 50%; 
            top: 50%;
            transform: translateY(-50%); /* 僅垂直居中修正 */
            
            display: flex;
            writing-mode: vertical-rl;
            text-orientation: upright;
            height: auto;
            max-height: 80vh;
            gap: 40px; /* 行距 */
        }
        .poem-line { font-size: 1.3rem; letter-spacing: 0.25em; line-height: 1.5; white-space: nowrap; font-weight: 500; }
        .poem-author { font-size: 0.9rem; margin-top: 30px; opacity: 0.6; writing-mode: vertical-rl; }

        /* --- PC Table of Contents (Slim Version) --- */
        .pc-toc-panel { 
            display: none; /* Mobile hidden */
            position: fixed; top: 0; right: 0; bottom: 0; 
            width: 80px; /* Slim width */
            background: var(--toc-bg-pc); 
            z-index: 150; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            gap: 20px;
        }
        .pc-toc-item { 
            writing-mode: vertical-rl; text-orientation: upright; 
            font-size: 0.85rem; color: var(--text-color); opacity: 0.3; 
            transition: all 0.4s var(--ease-out); 
            letter-spacing: 0.2em; cursor: none; padding: 10px 0;
            position: relative;
        }
        .pc-toc-item:hover, .pc-toc-item.active { opacity: 1; letter-spacing: 0.3em; font-weight: bold; }
        .pc-toc-item.active::after {
            content: ''; position: absolute; right: -10px; top: 50%; transform: translateY(-50%);
            width: 4px; height: 4px; background: var(--text-color); border-radius: 50%;
        }

        /* --- Mobile Wheel (Hidden on PC) --- */
        .mobile-wheel { display: none; position: fixed; bottom: -125px; left: 50%; transform: translateX(-50%); width: 250px; height: 250px; border-radius: 50%; z-index: 150; touch-action: none; pointer-events: none; }
        .wheel-container { width: 100%; height: 100%; position: relative; transition: transform 0.3s var(--ease-out); }
        .wheel-item { position: absolute; top: 50%; left: 50%; transform-origin: 0 0; writing-mode: vertical-rl; text-orientation: upright; font-size: 0.8rem; letter-spacing: 0.1em; opacity: 0.6; }
        .wheel-indicator { display: none; position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); width: 2px; height: 15px; background: var(--accent-color); z-index: 151; }

        /* --- End Page Hint --- */
        .end-hint { 
            position: fixed; bottom: 50px; width: 100%; 
            text-align: center; font-size: 0.9rem; letter-spacing: 2px;
            opacity: 0; transform: translateY(20px);
            transition: all 0.5s var(--ease-out); pointer-events: none; z-index: 300; 
        }
        .end-hint.visible { opacity: 1; transform: translateY(0); }

        /* Lightbox */
        .lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.4s var(--ease-out); display: flex; justify-content: center; align-items: center; }
        .lightbox.active { opacity: 1; pointer-events: auto; }
        .lightbox img { max-width: 95%; max-height: 95%; object-fit: contain; transform: scale(0.95); transition: transform 0.4s var(--ease-out); }
        .lightbox.active img { transform: scale(1); }

        /* --- Responsive & PC Logic --- */
        @media (min-width: 769px) {
            .pc-toc-panel { display: flex; }
            .mobile-wheel, .wheel-indicator { display: none !important; } /* Force hide wheel on PC */
        }
        @media (max-width: 768px) {
            body, html, a, button, img { cursor: auto !important; }
            #custom-cursor { display: none; }
            .mobile-wheel, .wheel-indicator { display: block; }
            .gallery-item { width: 70vw; }
            .gallery-scroll { padding: 0 15vw; }
            .poem-container { right: 50%; top: 50%; max-height: 70vh; }
            .poem-line { font-size: 1.1rem; }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; } }
    </style>
</head>
<body>
    <div id="custom-cursor"></div>
    
    <div class="back-arrow interactable" onclick="goHome()">
        <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </div>

    <div class="pc-toc-panel" id="pc-toc-list"></div>

    <div class="mobile-wheel" id="mobile-wheel"><div class="wheel-container" id="wheel-container"></div></div>
    <div class="wheel-indicator"></div>

    <div class="toast-msg" id="toast-msg" style="display:none;"></div> <div class="end-hint" id="end-hint">釋放以返回首頁</div>

    <div class="snap-container" id="main-scroll"></div>

    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
        <img id="lb-img" src="">
    </div>

    <script defer>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof momentsData === 'undefined') return;

        const scrollContainer = document.getElementById('main-scroll');
        const pcTocList = document.getElementById('pc-toc-list');
        const wheelContainer = document.getElementById('wheel-container');
        const totalSlides = momentsData.length;
        let isPC = window.innerWidth > 768;

        // --- 1. Content Generation ---
        momentsData.forEach((moment, index) => {
            const section = document.createElement('section');
            section.className = 'moment-section';
            section.id = `sec-${index}`;

            let innerHTML = '';
            if (moment.type === 'image') {
                innerHTML = `
                    <img data-src="${moment.content.imageSrc}" class="img-bg lazy-img">
                    <div class="bg-overlay"></div>
                    <div class="text-overlay">
                        <p class="moment-text interactable-text" onclick="copyText(this)">${moment.content.text}</p>
                    </div>`;
            } else if (moment.type === 'gallery') {
                section.classList.add('gallery-mode');
                const imgsHtml = moment.content.images.map((src, i) => 
                    `<div class="gallery-item interactable" onclick="event.stopPropagation(); openLightbox('${moment.id}', ${i})">
                        <img data-src="${src}" class="lazy-img">
                     </div>`
                ).join('');
                innerHTML = `<div class="gallery-text">${moment.content.text}</div><div class="gallery-scroll" onwheel="event.stopPropagation()">${imgsHtml}</div>`;
            } else if (moment.type === 'poem') {
                section.classList.add('poem-mode');
                const poemHTML = moment.content.lines.map(line => `<div class="poem-line">${line}</div>`).join('');
                innerHTML = `
                    <div class="poem-wrapper-outer interactable-text" onclick="copyText(this)">
                        <div class="poem-container">
                            ${poemHTML}
                            <div class="poem-author">—— ${moment.content.author}</div>
                        </div>
                    </div>`;
            }
            section.innerHTML = innerHTML;
            scrollContainer.appendChild(section);

            // Slim PC TOC Item
            const tocItem = document.createElement('div');
            tocItem.className = 'pc-toc-item interactable';
            tocItem.innerText = moment.title;
            tocItem.onclick = () => {
                section.scrollIntoView({ behavior: 'smooth' });
            };
            pcTocList.appendChild(tocItem);
        });

        // --- 2. Mobile Wheel Setup ---
        const radius = 125;
        momentsData.forEach((moment, index) => {
            const angleRad = (index / totalSlides) * 2 * Math.PI - Math.PI / 2;
            const x = radius * Math.cos(angleRad);
            const y = radius * Math.sin(angleRad);
            const item = document.createElement('div');
            item.className = 'wheel-item';
            item.innerText = moment.title;
            item.style.transform = `translate(${x}px, ${y}px) rotate(${angleRad * 180 / Math.PI + 90}deg)`;
            wheelContainer.appendChild(item);
        });

        // --- 3. Scroll & Wheel Logic (Strict One-per-step on PC) ---
        let isScrolling = false;
        let scrollTimeout;

        // PC Mouse Wheel Throttle - 確保電腦滾輪一次只動一格
        scrollContainer.addEventListener('wheel', (e) => {
            if (isPC) {
                e.preventDefault(); // 完全接管滾輪
                if (isScrolling) return;

                const direction = e.deltaY > 0 ? 1 : -1;
                const height = window.innerHeight;
                const currentScroll = scrollContainer.scrollTop;
                const currentIndex = Math.round(currentScroll / height);
                let nextIndex = currentIndex + direction;

                // 邊界檢查
                if (nextIndex < 0) nextIndex = 0;
                if (nextIndex >= totalSlides) {
                    // PC端 最後一頁繼續滾動觸發回首頁
                    if (direction > 0) handleEndTrigger();
                    nextIndex = totalSlides - 1;
                    return;
                }

                isScrolling = true;
                document.getElementById(`sec-${nextIndex}`).scrollIntoView({ behavior: 'smooth' });

                // 鎖定時間，防止飛速滾動
                setTimeout(() => { isScrolling = false; }, 800); 
            }
        }, { passive: false });

        // General Scroll Listener (Updates UI)
        scrollContainer.addEventListener('scroll', () => {
            const scrollY = scrollContainer.scrollTop;
            const height = window.innerHeight;
            const index = Math.round(scrollY / height);

            // Active Class for Animations
            document.querySelectorAll('.moment-section').forEach((sec, i) => {
                if (i === index) sec.classList.add('active');
                else sec.classList.remove('active');
            });

            // Update TOC
            document.querySelectorAll('.pc-toc-item').forEach((item, i) => item.classList.toggle('active', i === index));

            // Update Wheel
            const anglePerSlide = 360 / totalSlides;
            wheelContainer.style.transform = `rotate(${-index * anglePerSlide}deg)`;
        });

        // --- 4. Mobile End Page "Pull to Home" Logic ---
        let touchStartY = 0;
        let isPullingUp = false;
        const endHint = document.getElementById('end-hint');

        scrollContainer.addEventListener('touchstart', e => {
            touchStartY = e.touches[0].clientY;
            isPullingUp = false;
        }, { passive: true });

        scrollContainer.addEventListener('touchmove', e => {
            const currentY = e.touches[0].clientY;
            const deltaY = touchStartY - currentY; // Positive = Finger moving UP (content moves down)
            
            // Check if we are at the bottom
            const isAtBottom = scrollContainer.scrollHeight - scrollContainer.scrollTop <= scrollContainer.clientHeight + 2;

            if (isAtBottom && deltaY > 0) {
                // User is pulling up at the end
                isPullingUp = true;
                const pullDistance = Math.min(deltaY, 150); // Cap visual effect
                endHint.style.transform = `translateY(-${pullDistance / 2}px)`;
                endHint.style.opacity = Math.min(pullDistance / 80, 1);
                endHint.classList.add('visible');
            }
        }, { passive: true });

        scrollContainer.addEventListener('touchend', e => {
            if (isPullingUp) {
                const currentY = e.changedTouches[0].clientY;
                const deltaY = touchStartY - currentY;
                
                if (deltaY > 80) { // Threshold to trigger
                    goHome();
                } else {
                    // Reset hint
                    endHint.style.transform = '';
                    endHint.style.opacity = '';
                    endHint.classList.remove('visible');
                }
                isPullingUp = false;
            }
        });

        function handleEndTrigger() {
            endHint.innerText = "正在返回首頁...";
            endHint.classList.add('visible');
            setTimeout(goHome, 500);
        }

        // --- 5. Lazy Load ---
        const imgObserver = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    img.onload = () => img.classList.add('loaded');
                    imgObserver.unobserve(img);
                }
            });
        }, { threshold: 0.1 });
        document.querySelectorAll('.lazy-img').forEach(img => imgObserver.observe(img));

        // --- 6. Initialization ---
        // Trigger first active
        setTimeout(() => document.getElementById('sec-0').classList.add('active'), 100);
        bindCursorEvents();
    });

    // --- Global Helpers ---
    function goHome() { 
        document.body.style.animation = 'fadeOut 0.6s cubic-bezier(0.25, 1, 0.5, 1) forwards'; 
        setTimeout(() => window.location.href = 'home.html', 600); 
    }
    
    async function copyText(el) { try { await navigator.clipboard.writeText(el.innerText); } catch(e){} }
    
    window.openLightbox = function(momentId, index) {
        const momentData = momentsData.find(m => m.id === momentId);
        const imgSrc = momentData.content.images[index];
        document.getElementById('lb-img').src = imgSrc;
        document.getElementById('lightbox').classList.add('active');
    };
    window.closeLightbox = function() { document.getElementById('lightbox').classList.remove('active'); };

    const cursor = document.getElementById('custom-cursor');
    document.addEventListener('mousemove', e => { cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px'; });
    
    function bindCursorEvents() {
        document.querySelectorAll('.interactable, .interactable-text, .pc-toc-item, .gallery-item').forEach(el => {
            el.addEventListener('mouseenter', () => cursor.classList.add('hollow'));
            el.addEventListener('mouseleave', () => cursor.classList.remove('hollow'));
        });
    }
    </script>
</body>
</html>
