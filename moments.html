<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moments</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="./moments-data.js" defer></script>
    <style>
        :root {
            --bg-color: #ffffff; --text-color: #1a1a1a;
            --toc-width: 280px;
            --toc-gradient-pc: linear-gradient(to right, transparent 0%, var(--bg-color) 20%);
        }
        @media (prefers-color-scheme: dark) { 
            :root { 
                --bg-color: #000000; --text-color: #e5e5e5;
                --toc-gradient-pc: linear-gradient(to right, transparent 0%, var(--bg-color) 20%);
            } 
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html, a, button, img { cursor: none !important; }

        body { background: var(--bg-color); color: var(--text-color); font-family: 'Noto Serif TC', serif; height: 100vh; overflow: hidden; opacity: 0; animation: fadeIn 0.8s ease forwards; }

        /* --- UI & 通用組件 --- */
        .ui-icon { position: fixed; z-index: 1000; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; opacity: 0.6; transition: 0.3s; }
        .ui-icon:hover { opacity: 1; transform: scale(1.1); }
        .back-arrow { top: 30px; left: 30px; }
        .back-arrow svg { width: 24px; fill: var(--text-color); filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }
        .hamburger { top: 30px; right: 30px; flex-direction: column; justify-content: space-evenly; }
        .hamburger .line { width: 24px; height: 1.5px; background: var(--text-color); transition: 0.3s; mix-blend-mode: difference; }
        body.toc-active .hamburger .line:nth-child(1) { transform: translateY(6px) rotate(45deg); }
        body.toc-active .hamburger .line:nth-child(2) { opacity: 0; }
        body.toc-active .hamburger .line:nth-child(3) { transform: translateY(-6px) rotate(-45deg); }

        /* --- 內容容器 --- */
        .snap-container { height: 100vh; width: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .snap-container::-webkit-scrollbar { display: none; }
        .moment-section { height: 100vh; width: 100%; scroll-snap-align: start; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; }

        /* --- Moment 樣式 --- */
        .img-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1s ease; z-index: 1; }
        .img-bg.loaded { opacity: 1; }
        .bg-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.4)); z-index: 2; }
        .text-overlay { z-index: 3; position: relative; padding: 20px; max-width: 600px; text-align: center; color: #fff; }
        .moment-text { font-size: 1.1rem; line-height: 1.8; text-shadow: 0 2px 15px rgba(0,0,0,0.8); transition: transform 0.3s; }
        .moment-text:hover { transform: scale(1.02); } 
        .moment-text:active { transform: scale(0.98); }
        /* 多圖畫廊 */
        .gallery-container { display: flex; gap: 2vw; padding: 0 5vw; max-width: 100%; overflow-x: auto; z-index: 10; }
        .gallery-container::-webkit-scrollbar { display: none; }
        .gallery-item { flex: 0 0 auto; height: 40vh; max-height: 300px; border-radius: 4px; overflow: hidden; }
        .gallery-item img { height: 100%; width: auto; object-fit: cover; transition: 0.4s; }
        .gallery-item:hover img { transform: scale(1.05); }
        /* 詩歌 */
        .poem-mode { writing-mode: vertical-rl; text-orientation: upright; overflow-x: auto; justify-content: center; align-items: center; }
        .poem-content { font-size: 1.4rem; letter-spacing: 0.3em; line-height: 3; height: 80vh; display: inline-flex; flex-direction: column; flex-wrap: wrap; gap: 0 60px; padding: 0 5vw; padding-right: 40vw; }

        /* --- 最後一頁提示 --- */
        .return-hint { position: absolute; bottom: -60px; width: 100%; text-align: center; color: #fff; text-shadow: 0 1px 5px #000; z-index: 20; transition: 0.4s; }
        .return-hint.visible { bottom: 30px; }

        /* --- 燈箱 --- */
        .lightbox { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 9998; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.4s; }
        .lightbox.active { opacity: 1; pointer-events: auto; }
        .lightbox-img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .lightbox-nav { position: absolute; top: 50%; transform: translateY(-50%); width: 40px; height: 80px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; }
        .lightbox:hover .lightbox-nav { opacity: 1; }
        .lightbox-nav.prev { left: 2%; }
        .lightbox-nav.next { right: 2%; }
        .lightbox-nav svg { width: 24px; fill: #fff; }
        
        /* --- 電腦版目錄 (右側) --- */
        @media (min-width: 769px) {
            .toc-modal { position: fixed; top: 0; right: 0; width: var(--toc-width); height: 100vh; background: var(--toc-gradient-pc); display: flex; flex-direction: column; justify-content: center; padding: 0 30px 0 60px; z-index: 999; transform: translateX(100%); transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
            body.toc-active .toc-modal { transform: translateX(0); }
            body.toc-active .snap-container { width: calc(100% - var(--toc-width)); }
            .toc-list { display: flex; flex-direction: column; gap: 15px; }
            .toc-item { font-size: 1rem; opacity: 0.6; transition: 0.3s; white-space: nowrap; }
            .toc-item.current, .toc-item:hover { opacity: 1; transform: translateX(-10px); }
            .rotary-dial-container { display: none; } /* 電腦隱藏轉盤 */
        }

        /* --- 手機版轉盤目錄 --- */
        @media (max-width: 768px) {
            body, html, a, button, img { cursor: auto !important; }
            #custom-cursor, .toc-modal, .hamburger { display: none; }
            .rotary-dial-container { position: fixed; bottom: 0; left: 0; width: 100%; height: 150px; z-index: 999; overflow: hidden; pointer-events: none; }
            .rotary-dial { position: absolute; bottom: -150px; left: 50%; width: 300px; height: 300px; transform: translateX(-50%); border-radius: 50%; background: radial-gradient(circle, transparent 40%, var(--bg-color) 41%); pointer-events: auto; touch-action: none; transition: transform 0.3s ease-out; }
            .rotary-item { position: absolute; top: 0; left: 50%; height: 50%; transform-origin: bottom center; padding-top: 15px; font-size: 12px; opacity: 0.7; text-align: center; }
            .rotary-item.active { opacity: 1; font-weight: bold; }
        }
    </style>
</head>
<body class="toc-active"> <!-- 電腦默認展開 -->
    <div id="custom-cursor"></div>
    <div class="back-arrow ui-icon interactable" onclick="goBack()">
        <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </div>
    <div class="hamburger ui-icon interactable" onclick="toggleToc()">
        <div class="line"></div><div class="line"></div><div class="line"></div>
    </div>

    <!-- 電腦目錄 -->
    <div class="toc-modal"><div class="toc-list" id="toc-list-pc"></div></div>
    
    <!-- 手機轉盤 -->
    <div class="rotary-dial-container"><div class="rotary-dial" id="rotary-dial"></div></div>

    <!-- 燈箱 -->
    <div class="lightbox" id="lightbox">
        <img src="" class="lightbox-img" id="lightbox-img">
        <div class="lightbox-nav prev interactable" onclick="navigateLightbox(-1)"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg></div>
        <div class="lightbox-nav next interactable" onclick="navigateLightbox(1)"><svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></div>
    </div>

    <div class="snap-container" id="main-scroll"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof momentsData === 'undefined') { console.error('Data not loaded!'); return; }

        const scrollContainer = document.getElementById('main-scroll');
        const tocListPC = document.getElementById('toc-list-pc');
        const rotaryDial = document.getElementById('rotary-dial');
        const isMobile = window.innerWidth <= 768;

        // --- 1. 渲染內容 ---
        momentsData.forEach(moment => {
            const section = document.createElement('section');
            section.className = 'moment-section';
            section.id = moment.id;

            let contentHTML = '';
            if (moment.type === 'image') {
                contentHTML = `<img data-src="${moment.content.imageSrc}" class="img-bg lazy-img"><div class="bg-overlay"></div><div class="text-overlay"><p class="moment-text interactable-text" onclick="copyText(this)">${moment.content.text}</p>${moment.content.meta ? `<p class="meta">${moment.content.meta}</p>` : ''}</div>`;
            } else if (moment.type === 'poem') {
                section.classList.add('poem-mode');
                const poemLines = moment.content.lines.map(line => `<p>${line}</p>`).join('');
                contentHTML = `<div class="poem-content interactable-text" onclick="copyText(this)">${poemLines}</div>`;
            } else if (moment.type === 'gallery') {
                const galleryItems = moment.content.images.map((img, index) => `
                    <div class="gallery-item interactable-img" onclick="openLightbox('${moment.id}', ${index})">
                        <img data-src="${img.src}" class="lazy-img">
                    </div>
                `).join('');
                contentHTML = `<div class="text-overlay" style="position:absolute; top: 15%; color: #fff;">${moment.content.text ? `<p>${moment.content.text}</p>` : ''}</div><div class="gallery-container">${galleryItems}</div>`;
            }
            section.innerHTML = contentHTML;
            scrollContainer.appendChild(section);
        });
        
        // 添加最後一頁的提示
        const lastSection = scrollContainer.lastElementChild;
        if(lastSection) {
            const hint = document.createElement('div');
            hint.className = 'return-hint';
            hint.innerText = '再滑一次回到首頁';
            lastSection.appendChild(hint);
        }

        // --- 2. 渲染目錄 ---
        if (isMobile) {
            // 手機轉盤
            const angleStep = 30;
            momentsData.forEach((moment, i) => {
                const item = document.createElement('div');
                item.className = 'rotary-item';
                item.textContent = moment.title;
                item.style.transform = `rotate(${i * angleStep}deg) translateY(-150px)`;
                item.dataset.targetId = moment.id;
                item.dataset.index = i;
                rotaryDial.appendChild(item);
            });
            initRotaryDial();
        } else {
            // 電腦列表
            momentsData.forEach(moment => {
                const item = document.createElement('a');
                item.className = 'toc-item interactable';
                item.textContent = moment.title;
                item.dataset.targetId = moment.id;
                item.onclick = () => document.getElementById(moment.id).scrollIntoView({ behavior: 'smooth' });
                tocListPC.appendChild(item);
            });
        }
        
        // --- 3. 初始化交互 ---
        initLazyLoading();
        initScrollObserver();
        bindCursorEvents();
        if(isMobile) document.body.classList.remove('toc-active');
    });

    // --- 交互邏輯函數 ---
    let canReturnHome = false;
    function initScrollObserver() {
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                const id = entry.target.id;
                const tocItem = document.querySelector(`.toc-item[data-target-id="${id}"]`);
                if (tocItem) tocItem.classList.toggle('current', entry.isIntersecting);

                // 最後一頁邏輯
                if (entry.target.nextElementSibling === null && entry.isIntersecting) {
                    const hint = entry.target.querySelector('.return-hint');
                    entry.target.onwheel = (e) => {
                        if (e.deltaY > 0) { // 向下滾動
                            if (canReturnHome) goBack();
                            else {
                                hint.classList.add('visible');
                                canReturnHome = true;
                            }
                        }
                    };
                } else {
                    entry.target.onwheel = null;
                    canReturnHome = false;
                    const hint = entry.target.querySelector('.return-hint');
                    if(hint) hint.classList.remove('visible');
                }
            });
        }, { root: document.getElementById('main-scroll'), threshold: 0.5 });
        document.querySelectorAll('.moment-section').forEach(sec => observer.observe(sec));
    }
    
    function initLazyLoading() { /* ... 同上 ... */ }
    function toggleToc() { document.body.classList.toggle('toc-active'); }
    function goBack() { document.body.style.animation = 'fadeOut 0.5s ease forwards'; setTimeout(() => window.location.href = 'home.html', 500); }
    async function copyText(el) { /* ... 同上 ... */ }

    // 燈箱
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    let currentGalleryId = null;
    let currentImageIndex = 0;
    
    window.openLightbox = (momentId, index) => {
        const moment = momentsData.find(m => m.id === momentId);
        if(!moment || moment.type !== 'gallery') return;
        currentGalleryId = momentId;
        currentImageIndex = index;
        updateLightboxImage();
        lightbox.classList.add('active');
    };

    function updateLightboxImage() {
        const moment = momentsData.find(m => m.id === currentGalleryId);
        lightboxImg.src = moment.content.images[currentImageIndex].src;
    }

    window.navigateLightbox = (direction) => {
        const moment = momentsData.find(m => m.id === currentGalleryId);
        const newIndex = currentImageIndex + direction;
        if (newIndex >= 0 && newIndex < moment.content.images.length) {
            currentImageIndex = newIndex;
            updateLightboxImage();
        }
    };
    lightbox.onclick = (e) => { if (e.target === lightbox) lightbox.classList.remove('active'); };

    // 手機轉盤
    function initRotaryDial() {
        const dial = document.getElementById('rotary-dial');
        const items = dial.querySelectorAll('.rotary-item');
        const angleStep = 30;
        let startAngle = 0;
        let currentAngle = 0;
        let lastVibratedIndex = 0;

        dial.addEventListener('touchstart', e => {
            const touch = e.touches[0];
            const rect = dial.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            startAngle = Math.atan2(touch.clientY - centerY, touch.clientX - centerX) * (180 / Math.PI) - currentAngle;
        }, { passive: true });

        dial.addEventListener('touchmove', e => {
            const touch = e.touches[0];
            const rect = dial.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const moveAngle = Math.atan2(touch.clientY - centerY, touch.clientX - centerX) * (180 / Math.PI);
            currentAngle = moveAngle - startAngle;
            dial.style.transform = `translateX(-50%) rotate(${currentAngle}deg)`;
            
            // 實時更新高亮和震動
            const activeIndex = Math.round(-currentAngle / angleStep + momentsData.length) % momentsData.length;
            items.forEach((item, i) => item.classList.toggle('active', i === activeIndex));
            if (activeIndex !== lastVibratedIndex && navigator.vibrate) {
                navigator.vibrate(10);
                lastVibratedIndex = activeIndex;
            }

        }, { passive: true });

        dial.addEventListener('touchend', () => {
            const snapIndex = Math.round(-currentAngle / angleStep);
            const targetAngle = -snapIndex * angleStep;
            dial.style.transition = 'transform 0.3s ease-out';
            dial.style.transform = `translateX(-50%) rotate(${targetAngle}deg)`;
            currentAngle = targetAngle;
            
            // 滾動到目標
            const finalIndex = (snapIndex % momentsData.length + momentsData.length) % momentsData.length;
            const targetId = items[finalIndex].dataset.targetId;
            document.getElementById(targetId).scrollIntoView({ behavior: 'smooth' });
            
            setTimeout(() => dial.style.transition = '', 300);
        });
    }

    // 鼠標
    const cursor = document.getElementById('custom-cursor');
    function bindCursorEvents() { /* ... 同上 ... */ }
    // ... (其他輔助函數)
    </script>
</body>
</html>
